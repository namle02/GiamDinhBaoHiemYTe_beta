<UserControl
    x:Class="WPF_GiamDinhBaoHiem.View.PageView.QLHS_TimKiemHoSoPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:converter="clr-namespace:WPF_GiamDinhBaoHiem.Converter"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    x:Name="Root"
    Background="{DynamicResource MaterialDesignPaper}"
    mc:Ignorable="d">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis" />
        <converter:ErrorToColorConverter x:Key="ErrorToColor" />
        <converter:SafeErrorToColorConverter x:Key="SafeErrorToColor" />
        <converter:Xml1ErrorCountConverter x:Key="Xml1ErrorCountConverter" />
        <converter:Xml2ErrorCountConverter x:Key="Xml2ErrorCountConverter" />
        <converter:Xml3ErrorCountConverter x:Key="Xml3ErrorCountConverter" />

        <Style x:Key="CellTextBlock" TargetType="TextBlock">
            <Setter Property="TextTrimming" Value="CharacterEllipsis" />
            <Setter Property="ToolTip" Value="{Binding Text, RelativeSource={RelativeSource Self}}" />
            <Setter Property="VerticalAlignment" Value="Center" />
        </Style>

        <Style x:Key="ChipCount" TargetType="Border">
            <Setter Property="CornerRadius" Value="10" />
            <Setter Property="Padding" Value="6,2" />
            <Setter Property="Background" Value="{DynamicResource PrimaryHueLightBrush}" />
            <Setter Property="BorderBrush" Value="{DynamicResource PrimaryHueMidBrush}" />
            <Setter Property="BorderThickness" Value="1" />
        </Style>

        <Style TargetType="DataGridColumnHeader">
            <Setter Property="HorizontalContentAlignment" Value="Center" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="Background" Value="#FAFAFA" />
            <Setter Property="Padding" Value="8,6" />
        </Style>

        <Style TargetType="DataGrid">
            <Setter Property="RowHeaderWidth" Value="0" />
            <Setter Property="AlternatingRowBackground" Value="#11000000" />
            <Setter Property="AlternationCount" Value="2" />
            <Setter Property="GridLinesVisibility" Value="None" />
            <Setter Property="EnableRowVirtualization" Value="True" />
            <Setter Property="EnableColumnVirtualization" Value="True" />
        </Style>

        <!--  Pastel header colors per XML tab  -->
        <SolidColorBrush x:Key="Xml1Header" Color="#E6F4FF" />
        <SolidColorBrush x:Key="Xml2Header" Color="#FFF5E6" />
        <SolidColorBrush x:Key="Xml3Header" Color="#E8FFF3" />
        <SolidColorBrush x:Key="Xml4Header" Color="#FDEDF2" />
        <SolidColorBrush x:Key="Xml5Header" Color="#F3FDE8" />
        <SolidColorBrush x:Key="Xml6Header" Color="#EDEBFF" />
        <SolidColorBrush x:Key="Xml7Header" Color="#FFEFE6" />
        <SolidColorBrush x:Key="Xml8Header" Color="#E6FFF9" />
        <SolidColorBrush x:Key="Xml9Header" Color="#FFF0F5" />
        <SolidColorBrush x:Key="Xml10Header" Color="#FFFBE6" />
        <SolidColorBrush x:Key="Xml11Header" Color="#EAF2FF" />
        <SolidColorBrush x:Key="Xml12Header" Color="#F6E6FF" />
        <SolidColorBrush x:Key="Xml13Header" Color="#E6FFF0" />
        <SolidColorBrush x:Key="Xml14Header" Color="#FFE6F2" />
        <SolidColorBrush x:Key="Xml15Header" Color="#E6F0FF" />
        <SolidColorBrush x:Key="XmlDefaultHeader" Color="#F3F4F6" />

        <!--  Colored TabItem header style  -->
        <Style x:Key="ColoredTabItem" TargetType="TabItem">
            <Setter Property="Margin" Value="2,0,2,0" />
            <Setter Property="Padding" Value="8,4" />
            <Setter Property="Background" Value="{StaticResource XmlDefaultHeader}" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TabItem">
                        <Border
                            x:Name="Bd"
                            Padding="0"
                            Background="{TemplateBinding Background}"
                            BorderBrush="#D1D5DB"
                            BorderThickness="1"
                            CornerRadius="6,6,0,0">
                            <ContentPresenter
                                x:Name="Content"
                                Margin="10,4"
                                ContentSource="Header"
                                RecognizesAccessKey="True" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Bd" Property="BorderBrush" Value="#9CA3AF" />
                                <Setter TargetName="Bd" Property="RenderOptions.BitmapScalingMode" Value="HighQuality" />
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.6" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML1">
                    <Setter Property="Background" Value="{StaticResource Xml1Header}" />
                </DataTrigger>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML2">
                    <Setter Property="Background" Value="{StaticResource Xml2Header}" />
                </DataTrigger>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML3">
                    <Setter Property="Background" Value="{StaticResource Xml3Header}" />
                </DataTrigger>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML4">
                    <Setter Property="Background" Value="{StaticResource Xml4Header}" />
                </DataTrigger>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML5">
                    <Setter Property="Background" Value="{StaticResource Xml5Header}" />
                </DataTrigger>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML6">
                    <Setter Property="Background" Value="{StaticResource Xml6Header}" />
                </DataTrigger>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML7">
                    <Setter Property="Background" Value="{StaticResource Xml7Header}" />
                </DataTrigger>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML8">
                    <Setter Property="Background" Value="{StaticResource Xml8Header}" />
                </DataTrigger>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML9">
                    <Setter Property="Background" Value="{StaticResource Xml9Header}" />
                </DataTrigger>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML10">
                    <Setter Property="Background" Value="{StaticResource Xml10Header}" />
                </DataTrigger>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML11">
                    <Setter Property="Background" Value="{StaticResource Xml11Header}" />
                </DataTrigger>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML12">
                    <Setter Property="Background" Value="{StaticResource Xml12Header}" />
                </DataTrigger>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML13">
                    <Setter Property="Background" Value="{StaticResource Xml13Header}" />
                </DataTrigger>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML14">
                    <Setter Property="Background" Value="{StaticResource Xml14Header}" />
                </DataTrigger>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML15">
                    <Setter Property="Background" Value="{StaticResource Xml15Header}" />
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="8" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!--  SEARCH  -->
        <materialDesign:Card Padding="16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <TextBox
                    MinHeight="48"
                    VerticalContentAlignment="Center"
                    materialDesign:HintAssist.Hint="Nhập số bệnh án / số tiếp nhận rồi nhấn Enter"
                    materialDesign:TextFieldAssist.HasClearButton="True"
                    FontSize="18"
                    Style="{StaticResource MaterialDesignOutlinedTextBox}"
                    Text="{Binding PatientID, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}">
                    <TextBox.InputBindings>
                        <KeyBinding Key="Enter" Command="{Binding TraCuuHoSoCommand}" />
                    </TextBox.InputBindings>
                </TextBox>

                <Button
                    Grid.Column="1"
                    Height="48"
                    MinWidth="140"
                    Margin="12,0,0,0"
                    Command="{Binding TraCuuHoSoCommand}">
                    <StackPanel VerticalAlignment="Center" Orientation="Horizontal">
                        <materialDesign:PackIcon
                            Width="20"
                            Height="20"
                            Margin="0,0,8,0"
                            Kind="Search" />
                        <TextBlock FontSize="16" Text="Tra cứu" />
                    </StackPanel>
                </Button>

                <StackPanel
                    Grid.Column="2"
                    Margin="16,0,0,0"
                    VerticalAlignment="Center"
                    Orientation="Horizontal">
                    <Border Style="{StaticResource ChipCount}">
                        <TextBlock>
                            <Run Text="Kết quả: " />
                            <Run Text="{Binding Items.Count, ElementName=PatientsGrid, Mode=OneWay}" />
                        </TextBlock>
                    </Border>
                </StackPanel>
            </Grid>
        </materialDesign:Card>

        <Border Grid.Row="1" />

        <!--  GRID  -->
        <Grid Grid.Row="2">
            <DataGrid
                x:Name="PatientsGrid"
                AutoGenerateColumns="False"
                CanUserAddRows="False"
                FrozenColumnCount="5"
                IsReadOnly="True"
                ItemsSource="{Binding Patients}"
                RowDetailsVisibilityMode="VisibleWhenSelected"
                ScrollViewer.CanContentScroll="False"
                ScrollViewer.HorizontalScrollBarVisibility="Auto"
                ScrollViewer.VerticalScrollBarVisibility="Auto"
                SelectedItem="{Binding SelectedPatient, Mode=TwoWay}"
                VirtualizingPanel.IsVirtualizing="True"
                VirtualizingPanel.ScrollUnit="Pixel"
                VirtualizingPanel.VirtualizationMode="Recycling">

                <!--  CỘT CHÍNH (bind vào Xml1[0].*)  -->
                <DataGrid.Columns>
                    <DataGridTextColumn
                        Width="120"
                        Binding="{Binding Xml1[0].Id}"
                        Header="ID" />
                    <DataGridTextColumn
                        Width="80"
                        Binding="{Binding Xml1[0].Stt}"
                        Header="STT" />
                    <DataGridTextColumn
                        Width="140"
                        Binding="{Binding Xml1[0].Ma_Lk}"
                        Header="MÃ LK">
                        <DataGridTextColumn.ElementStyle>
                            <Style BasedOn="{StaticResource CellTextBlock}" TargetType="TextBlock" />
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    <DataGridTextColumn
                        Width="110"
                        Binding="{Binding Xml1[0].Ma_Bn}"
                        Header="MÃ BN" />
                    <DataGridTemplateColumn Width="220" Header="HỌ TÊN">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock
                                    FontWeight="SemiBold"
                                    Style="{StaticResource CellTextBlock}"
                                    Text="{Binding Xml1[0].Ho_Ten}" />
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    <DataGridTextColumn
                        Width="160"
                        Binding="{Binding Xml1[0].Ngay_Vao}"
                        Header="NGÀY VÀO" />
                    <DataGridTextColumn
                        Width="160"
                        Binding="{Binding Xml1[0].Ngay_Ra}"
                        Header="NGÀY RA" />
                </DataGrid.Columns>

                <!--  CHI TIẾT HÀNG -> TabControl: XML1..XML15  -->
                <DataGrid.RowDetailsTemplate>
                    <DataTemplate>
                        <!--  RowDetails DataContext = PatientData  -->
                        <Border
                            Margin="0,0,0,8"
                            Padding="12"
                            Background="#FFF9F9F9"
                            BorderBrush="#1F000000"
                            BorderThickness="1">
                            <TabControl ItemContainerStyle="{StaticResource ColoredTabItem}">
                                <!--  XML1  -->
                                <TabItem>
                                    <TabItem.Header>
                                        <TextBlock Foreground="{Binding Xml1[0].Error.XML1Header, Converter={StaticResource ErrorToColor}}" Text="XML1" />
                                    </TabItem.Header>
                                    <ScrollViewer HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
                                        <!--  Lấy dòng đầu tiên của Xml1 để show thông tin chính  -->
                                        <Grid Margin="0,8,0,0" DataContext="{Binding Xml1[0]}">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="2*" />
                                                <ColumnDefinition Width="2*" />
                                                <ColumnDefinition Width="2*" />
                                                <ColumnDefinition Width="2*" />
                                            </Grid.ColumnDefinitions>

                                            <!--  1) Nhân thân & cư trú  -->
                                            <StackPanel Margin="4">
                                                <TextBlock FontWeight="SemiBold" Text="SỐ CCCD:" />
                                                <TextBlock Text="{Binding So_Cccd}" />
                                                <TextBlock
                                                    Margin="0,6,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="NGÀY SINH:" />
                                                <TextBlock Text="{Binding Ngay_Sinh}" />
                                                <TextBlock
                                                    Margin="0,6,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="GIỚI TÍNH (int):" />
                                                <TextBlock Foreground="{Binding Error.Gioi_Tinh, Converter={StaticResource ErrorToColor}}" Text="{Binding Gioi_Tinh}" />
                                                <TextBlock
                                                    Margin="0,6,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="QUỐC TỊCH:" />
                                                <TextBlock Text="{Binding Ma_QuocTich}" />
                                                <TextBlock
                                                    Margin="0,6,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="DÂN TỘC:" />
                                                <TextBlock Foreground="{Binding Error.Ma_DanToc, Converter={StaticResource ErrorToColor}}" Text="{Binding Ma_DanToc}" />
                                                <TextBlock
                                                    Margin="0,6,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="NGHỀ NGHIỆP:" />
                                                <TextBlock Text="{Binding Ma_Nghe_Nghiep}" />
                                                <TextBlock
                                                    Margin="0,6,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="ĐIỆN THOẠI:" />
                                                <TextBlock Text="{Binding Dien_Thoai}" />
                                                <TextBlock
                                                    Margin="0,6,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="ĐỊA CHỈ:" />
                                                <TextBlock Text="{Binding Dia_Chi}" TextWrapping="Wrap" />
                                                <TextBlock
                                                    Margin="0,6,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="TỈNH/HUYỆN/XÃ CƯ TRÚ:" />
                                                <TextBlock>
                                                    <Run Text="{Binding Matinh_Cu_Tru}" />
                                                    <Run Text=" - " />
                                                    <Run Text="{Binding Mahuyen_Cu_Tru}" />
                                                    <Run Text=" - " />
                                                    <Run Text="{Binding Maxa_Cu_Tru}" />
                                                </TextBlock>
                                            </StackPanel>

                                            <!--  2) BHYT & lý do  -->
                                            <StackPanel Grid.Column="1" Margin="4">
                                                <TextBlock FontWeight="SemiBold" Text="MÃ THẺ BHYT:" />
                                                <TextBlock Text="{Binding Ma_The_Bhyt}" />
                                                <TextBlock
                                                    Margin="0,6,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="MÃ ĐKBD:" />
                                                <TextBlock Text="{Binding Ma_Dkbd}" />
                                                <TextBlock
                                                    Margin="0,6,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="GT THẺ (Từ - Đến):" />
                                                <TextBlock>
                                                    <Run Text="{Binding Gt_The_Tu}" />
                                                    <Run Text=" - " />
                                                    <Run Text="{Binding Gt_The_Den}" />
                                                </TextBlock>
                                                <TextBlock
                                                    Margin="0,6,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="NGÀY MIỄN CCT:" />
                                                <TextBlock Text="{Binding Ngay_Mien_Cct}" />
                                                <TextBlock
                                                    Margin="0,6,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="LÝ DO VÀO VIỆN:" />
                                                <TextBlock Text="{Binding Ly_Do_Vv}" />
                                                <TextBlock
                                                    Margin="0,6,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="LÝ DO VNT / MÃ:" />
                                                <TextBlock>
                                                    <Run Text="{Binding Ly_Do_Vnt}" />
                                                    <Run Text=" / " />
                                                    <Run Text="{Binding Ma_Ly_Do_Vnt}" />
                                                </TextBlock>
                                            </StackPanel>

                                            <!--  3) Chẩn đoán, mã bệnh, chuyển tuyến  -->
                                            <StackPanel Grid.Column="2" Margin="4">
                                                <TextBlock FontWeight="SemiBold" Text="CHẨN ĐOÁN VÀO:" />
                                                <TextBlock Text="{Binding Chan_DoAn_Vao}" TextWrapping="Wrap" />
                                                <TextBlock
                                                    Margin="0,6,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="CHẨN ĐOÁN RA:" />
                                                <TextBlock Text="{Binding Chan_DoAn_Rv}" TextWrapping="Wrap" />
                                                <TextBlock
                                                    Margin="0,6,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="MÃ BỆNH CHÍNH:" />
                                                <TextBlock Text="{Binding Ma_Benh_Chinh}" />
                                                <TextBlock
                                                    Margin="0,6,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="MÃ BỆNH KÈM THEO:" />
                                                <TextBlock Text="{Binding Ma_Benh_Kt}" />
                                                <TextBlock
                                                    Margin="0,6,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="MÃ BỆNH YHCT:" />
                                                <TextBlock Text="{Binding Ma_Benh_Yhct}" />
                                                <TextBlock
                                                    Margin="0,6,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="MÃ PTTT QT:" />
                                                <TextBlock Text="{Binding Ma_Pttt_Qt}" />
                                                <TextBlock
                                                    Margin="0,6,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="NƠI ĐI / ĐẾN:" />
                                                <TextBlock>
                                                    <Run Text="{Binding Ma_Noi_Di}" />
                                                    <Run Text=" → " />
                                                    <Run Text="{Binding Ma_Noi_Den}" />
                                                </TextBlock>
                                                <TextBlock
                                                    Margin="0,6,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="MÃ TAI NẠN :" />
                                                <TextBlock Text="{Binding Ma_Tai_Nan}" />
                                                <TextBlock
                                                    Margin="0,6,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="GIẤY CHUYỂN TUYẾN:" />
                                                <TextBlock Text="{Binding Giay_Chuyen_Tuyen}" />
                                            </StackPanel>

                                            <!--  4) Điều trị & tài chính  -->
                                            <StackPanel Grid.Column="3" Margin="4">
                                                <TextBlock FontWeight="SemiBold" Text="NGÀY VÀO / VÀO NỘI TRÚ / RA:" />
                                                <TextBlock>
                                                    <Run Text="{Binding Ngay_Vao}" />
                                                    <Run Text=" | " />
                                                    <Run Text="{Binding Ngay_Vao_Noi_Tru}" />
                                                    <Run Text=" | " />
                                                    <Run Text="{Binding Ngay_Ra}" />
                                                </TextBlock>
                                                <TextBlock
                                                    Margin="0,6,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="SỐ NGÀY ĐIỀU TRỊ / PP ĐIỀU TRỊ:" />
                                                <TextBlock>
                                                    <Run Text="{Binding So_Ngay_Dtri}" />
                                                    <Run Text=" | " />
                                                    <Run Text="{Binding Pp_Dieu_Tri}" />
                                                </TextBlock>
                                                <TextBlock
                                                    Margin="0,6,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="KẾT QUẢ ĐIỀU TRỊ (int?):" />
                                                <TextBlock Text="{Binding Ket_Qua_Dtri}" />
                                                <TextBlock
                                                    Margin="0,6,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="LOẠI RA VIỆN (mã):" />
                                                <TextBlock Text="{Binding Ma_Loai_Rv}" />
                                                <TextBlock
                                                    Margin="0,6,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="GHI CHÚ / NGÀY T.TOÁN:" />
                                                <TextBlock>
                                                    <Run Text="{Binding Ghi_Chu}" />
                                                    <Run Text=" | " />
                                                    <Run Text="{Binding Ngay_Ttoan}" />
                                                </TextBlock>

                                                <TextBlock
                                                    Margin="8,10,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="TỔNG CHI BV / BH:" />
                                                <TextBlock>
                                                    <Run Text="{Binding T_TongChi_Bv}" />
                                                    <Run Text=" / " />
                                                    <Run Text="{Binding T_TongChi_Bh}" />
                                                </TextBlock>
                                                <TextBlock
                                                    Margin="0,6,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="BNTT / BNCCT / BHTT / NGUỒN KHÁC / BHTT GDV:" />
                                                <TextBlock>
                                                    <Run Text="{Binding T_Bntt}" />
                                                    <Run Text=" / " />
                                                    <Run Text="{Binding T_Bncct}" />
                                                    <Run Text=" / " />
                                                    <Run Text="{Binding T_Bhtt}" />
                                                    <Run Text=" / " />
                                                    <Run Text="{Binding T_NguonKhac}" />
                                                    <Run Text=" / " />
                                                    <Run Text="{Binding T_Bhtt_Gdv}" />
                                                </TextBlock>
                                                <TextBlock
                                                    Margin="0,6,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="THUỐC / VTYT:" />
                                                <TextBlock>
                                                    <Run Text="{Binding T_Thuoc}" />
                                                    <Run Text=" / " />
                                                    <Run Text="{Binding T_Vtyt}" />
                                                </TextBlock>

                                                <TextBlock
                                                    Margin="8,10,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="NĂM-QT / THÁNG-QT:" />
                                                <TextBlock>
                                                    <Run Text="{Binding Nam_Qt}" />
                                                    <Run Text=" - " />
                                                    <Run Text="{Binding Thang_Qt}" />
                                                </TextBlock>
                                                <TextBlock
                                                    Margin="0,6,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="LOẠI KCB / KHOA / CSKCB / KHU VỰC:" />
                                                <TextBlock>
                                                    <Run Text="{Binding Ma_Loai_Kcb}" />
                                                    <Run Text=" | " />
                                                    <Run Text="{Binding Ma_Khoa}" />
                                                    <Run Text=" | " />
                                                    <Run Text="{Binding Ma_Cskcb}" />
                                                    <Run Text=" | " />
                                                    <Run Text="{Binding Ma_KhuVuc}" />
                                                </TextBlock>
                                                <TextBlock
                                                    Margin="0,6,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="CÂN NẶNG / CÂN NẶNG CON / NĂM LIÊN TỤC / NGÀY TÁI KHÁM:" />
                                                <TextBlock>
                                                    <Run Text="{Binding Can_Nang}" />
                                                    <Run Text=" | " />
                                                    <Run Text="{Binding Can_Nang_Con}" />
                                                    <Run Text=" | " />
                                                    <Run Text="{Binding Nam_Nam_Lien_Tuc}" />
                                                    <Run Text=" | " />
                                                    <Run Text="{Binding Ngay_Tai_Kham}" />
                                                </TextBlock>
                                                <TextBlock
                                                    Margin="0,6,0,0"
                                                    FontWeight="SemiBold"
                                                    Text="HSBA / TTDV / DỰ PHÒNG / NHÓM MÁU:" />
                                                <TextBlock>
                                                    <Run Text="{Binding Ma_Hsba}" />
                                                    <Run Text=" | " />
                                                    <Run Text="{Binding Ma_Ttdv}" />
                                                    <Run Text=" | " />
                                                    <Run Text="{Binding Du_Phong}" />
                                                    <Run Text=" | " />
                                                    <Run Text="{Binding Nhom_Mau}" />
                                                </TextBlock>
                                            </StackPanel>
                                        </Grid>
                                    </ScrollViewer>
                                </TabItem>

                                <!--  XML2  -->
                                <TabItem>
                                    <TabItem.Header>
                                        <TextBlock Foreground="{Binding Xml2HeaderError, Converter={StaticResource SafeErrorToColor}}" Text="XML2" />
                                    </TabItem.Header>
                                    <Grid Margin="0,4,0,0">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="*" />
                                        </Grid.RowDefinitions>

                                        <TextBlock
                                            Grid.Row="0"
                                            Margin="0,0,0,6"
                                            FontWeight="SemiBold"
                                            Text="Danh sách thuốc" />

                                        <TextBlock
                                            Grid.Row="0"
                                            Margin="0,22,0,6"
                                            FontStyle="Italic"
                                            Opacity="0.6"
                                            Text="Chọn một dòng để xem đầy đủ chi tiết. Các cột đã được rút gọn để tránh phải kéo ngang." />

                                        <!--  DATA GRID  -->
                                        <DataGrid
                                            x:Name="Xml2Grid"
                                            Grid.Row="1"
                                            AutoGenerateColumns="False"
                                            CanUserAddRows="False"
                                            CanUserDeleteRows="False"
                                            ColumnWidth="Auto"
                                            GridLinesVisibility="None"
                                            HeadersVisibility="Column"
                                            IsReadOnly="True"
                                            ItemsSource="{Binding Xml2}"
                                            MinColumnWidth="80"
                                            RowDetailsVisibilityMode="VisibleWhenSelected"
                                            ScrollViewer.HorizontalScrollBarVisibility="Auto"
                                            ScrollViewer.VerticalScrollBarVisibility="Auto">

                                            <!--  Row style without code-behind handlers  -->
                                            <DataGrid.RowStyle>
                                                <Style TargetType="DataGridRow">
                                                    <EventSetter Event="PreviewMouseLeftButtonDown" Handler="DataGridRow_PreviewMouseLeftButtonDown" />
                                                </Style>
                                            </DataGrid.RowStyle>

                                            <!--  Ẩn DataGrid khi không có item  -->
                                            <DataGrid.Style>
                                                <Style TargetType="DataGrid">
                                                    <Setter Property="Visibility" Value="Visible" />
                                                    <Style.Triggers>
                                                        <Trigger Property="HasItems" Value="False">
                                                            <Setter Property="Visibility" Value="Collapsed" />
                                                        </Trigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </DataGrid.Style>

                                            <!--  style canh phải cho số  -->
                                            <DataGrid.Resources>
                                                <Style x:Key="RightCell" TargetType="TextBlock">
                                                    <Setter Property="TextAlignment" Value="Right" />
                                                    <Setter Property="Margin" Value="0,0,6,0" />
                                                </Style>
                                            </DataGrid.Resources>

                                            <!--  CỘT TÓM TẮT: rút gọn để không cần kéo ngang  -->
                                            <DataGrid.Columns>
                                                <DataGridTextColumn
                                                    Width="70"
                                                    Binding="{Binding Stt}"
                                                    ElementStyle="{StaticResource RightCell}"
                                                    Header="STT" />
                                                <DataGridTextColumn
                                                    Width="120"
                                                    Binding="{Binding Ma_Thuoc}"
                                                    Header="Mã thuốc" />
                                                <DataGridTextColumn Width="300" Header="Tên thuốc">
                                                    <DataGridTextColumn.ElementStyle>
                                                        <Style BasedOn="{StaticResource CellTextBlock}" TargetType="TextBlock" />
                                                    </DataGridTextColumn.ElementStyle>
                                                    <DataGridTextColumn.Binding>
                                                        <Binding Path="Ten_Thuoc" />
                                                    </DataGridTextColumn.Binding>
                                                </DataGridTextColumn>
                                                <DataGridTextColumn
                                                    Width="90"
                                                    Binding="{Binding Don_Vi_Tinh}"
                                                    Header="ĐVT" />
                                                <DataGridTextColumn
                                                    Width="110"
                                                    Binding="{Binding So_Luong, StringFormat=N2}"
                                                    ElementStyle="{StaticResource RightCell}"
                                                    Header="SL" />
                                                <DataGridTextColumn
                                                    Width="120"
                                                    Binding="{Binding Don_Gia, StringFormat=N2}"
                                                    ElementStyle="{StaticResource RightCell}"
                                                    Header="Đơn giá" />
                                                <DataGridTextColumn
                                                    Width="140"
                                                    Binding="{Binding Thanh_Tien_Bh, StringFormat=N2}"
                                                    ElementStyle="{StaticResource RightCell}"
                                                    Header="Thành tiền BH" />
                                            </DataGrid.Columns>

                                            <!--  CHI TIẾT HÀNG: hiển thị toàn bộ trường theo chiều dọc  -->
                                            <DataGrid.RowDetailsTemplate>
                                                <DataTemplate>
                                                    <Border
                                                        Margin="0,4,0,8"
                                                        Padding="10"
                                                        Background="#FFF9F9F9"
                                                        BorderBrush="#1F000000"
                                                        BorderThickness="1">
                                                        <ScrollViewer HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
                                                            <WrapPanel MinWidth="400" ItemWidth="260">
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="ID" />
                                                                    <TextBlock Text="{Binding Id}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Mã LK" />
                                                                    <TextBlock Text="{Binding Ma_Lk}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="STT" />
                                                                    <TextBlock Text="{Binding Stt}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Mã thuốc" />
                                                                    <TextBlock Foreground="{Binding Error.Ma_Thuoc, Converter={StaticResource ErrorToColor}}" Text="{Binding Ma_Thuoc}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Tên thuốc" />
                                                                    <TextBlock
                                                                        Foreground="{Binding Error.Ten_Thuoc, Converter={StaticResource ErrorToColor}}"
                                                                        Text="{Binding Ten_Thuoc}"
                                                                        TextWrapping="Wrap" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Đơn vị tính" />
                                                                    <TextBlock Text="{Binding Don_Vi_Tinh}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Hàm lượng" />
                                                                    <TextBlock Text="{Binding Ham_Luong}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Dạng bào chế" />
                                                                    <TextBlock Text="{Binding Dang_Bao_Che}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Đường dùng" />
                                                                    <TextBlock Text="{Binding Duong_Dung}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Liều dùng" />
                                                                    <TextBlock Text="{Binding Lieu_Dung}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Cách dùng" />
                                                                    <TextBlock Text="{Binding Cach_Dung}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Mã PP chế biến" />
                                                                    <TextBlock Text="{Binding Ma_Pp_CheBien}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Mã CSKCB thuốc" />
                                                                    <TextBlock Text="{Binding Ma_Cskcb_Thuoc}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Mã nhóm" />
                                                                    <TextBlock Text="{Binding Ma_Nhom}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Số đăng ký" />
                                                                    <TextBlock Text="{Binding So_Dang_Ky}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="TT thầu" />
                                                                    <TextBlock Text="{Binding Tt_Thau}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Phạm vi" />
                                                                    <TextBlock Text="{Binding Pham_Vi}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Tỷ lệ TT BH" />
                                                                    <TextBlock Text="{Binding Tyle_Tt_Bh, StringFormat=N2}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Số lượng" />
                                                                    <TextBlock Text="{Binding So_Luong, StringFormat=N2}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Đơn giá" />
                                                                    <TextBlock Text="{Binding Don_Gia, StringFormat=N2}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Thành tiền BV" />
                                                                    <TextBlock Text="{Binding Thanh_Tien_Bv, StringFormat=N2}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Thành tiền BH" />
                                                                    <TextBlock Text="{Binding Thanh_Tien_Bh, StringFormat=N2}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="NSNN" />
                                                                    <TextBlock Text="{Binding T_NguonKhac_Nsnn, StringFormat=N2}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="VTNN" />
                                                                    <TextBlock Text="{Binding T_NguonKhac_Vtnn, StringFormat=N2}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="VTTN" />
                                                                    <TextBlock Text="{Binding T_NguonKhac_Vttn, StringFormat=N2}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="CL" />
                                                                    <TextBlock Text="{Binding T_NguonKhac_Cl, StringFormat=N2}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Nguồn khác (T)" />
                                                                    <TextBlock Text="{Binding T_NguonKhac, StringFormat=N2}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Mức hưởng" />
                                                                    <TextBlock Text="{Binding Muc_Huong, StringFormat=N0}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="BNTT" />
                                                                    <TextBlock Text="{Binding T_Bntt, StringFormat=N2}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="BNCCT" />
                                                                    <TextBlock Text="{Binding T_Bncct, StringFormat=N2}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="BHTT" />
                                                                    <TextBlock Text="{Binding T_Bhtt, StringFormat=N2}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Mã khoa" />
                                                                    <TextBlock Text="{Binding Ma_Khoa}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Mã bác sĩ" />
                                                                    <TextBlock Text="{Binding Ma_Bac_Si}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Mã dịch vụ" />
                                                                    <TextBlock Text="{Binding Ma_Dich_Vu}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Ngày YL" />
                                                                    <TextBlock Text="{Binding Ngay_Yl}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Mã PTTT" />
                                                                    <TextBlock Text="{Binding Ma_Pttt}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Nguồn chi trả" />
                                                                    <TextBlock Text="{Binding Nguon_Ctra}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Vết thương TP" />
                                                                    <TextBlock Text="{Binding Vet_Thuong_Tp}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Dự phòng" />
                                                                    <TextBlock Text="{Binding Du_Phong}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Ngày TH YL" />
                                                                    <TextBlock Text="{Binding Ngay_Th_Yl}" />
                                                                </StackPanel>
                                                            </WrapPanel>
                                                        </ScrollViewer>
                                                    </Border>
                                                </DataTemplate>
                                            </DataGrid.RowDetailsTemplate>
                                        </DataGrid>

                                        <!--  PLACEHOLDER khi rỗng  -->
                                        <Border
                                            Grid.Row="1"
                                            Padding="16"
                                            Background="Transparent">
                                            <TextBlock
                                                HorizontalAlignment="Center"
                                                VerticalAlignment="Center"
                                                Opacity="0.6"
                                                Text="Không có dữ liệu XML2." />
                                            <Border.Style>
                                                <Style TargetType="Border">
                                                    <Setter Property="Visibility" Value="Collapsed" />
                                                    <Style.Triggers>
                                                        <!--  Dựa theo HasItems của chính DataGrid  -->
                                                        <DataTrigger Binding="{Binding ElementName=Xml2Grid, Path=HasItems}" Value="False">
                                                            <Setter Property="Visibility" Value="Visible" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Border.Style>
                                        </Border>
                                    </Grid>
                                </TabItem>



                                <!--  XML3..XML15: giữ placeholder  -->
                                <TabItem>
                                    <TabItem.Header>
                                        <TextBlock Foreground="{Binding Xml3HeaderError, Converter={StaticResource SafeErrorToColor}}" Text="XML3" />
                                    </TabItem.Header>
                                    <Grid Margin="0,4,0,0">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="*" />
                                        </Grid.RowDefinitions>

                                        <TextBlock
                                            Grid.Row="0"
                                            Margin="0,0,0,6"
                                            FontWeight="SemiBold"
                                            Text="Danh sách DVKT/VTYT (XML3)" />
                                        <TextBlock
                                            Grid.Row="0"
                                            Margin="0,22,0,6"
                                            FontStyle="Italic"
                                            Opacity="0.6"
                                            Text="Chọn một dòng để xem đầy đủ chi tiết. Các cột đã được rút gọn để tránh phải kéo ngang." />

                                        <!--  DATA GRID  -->
                                        <DataGrid
                                            x:Name="Xml3Grid"
                                            Grid.Row="1"
                                            AutoGenerateColumns="False"
                                            CanUserAddRows="False"
                                            CanUserDeleteRows="False"
                                            ColumnWidth="Auto"
                                            GridLinesVisibility="None"
                                            HeadersVisibility="Column"
                                            IsReadOnly="True"
                                            ItemsSource="{Binding Xml3}"
                                            MinColumnWidth="80"
                                            RowDetailsVisibilityMode="VisibleWhenSelected"
                                            ScrollViewer.HorizontalScrollBarVisibility="Auto"
                                            ScrollViewer.VerticalScrollBarVisibility="Auto">

                                            <!--  Ẩn DataGrid khi rỗng  -->
                                            <DataGrid.Style>
                                                <Style TargetType="DataGrid">
                                                    <Setter Property="Visibility" Value="Visible" />
                                                    <Style.Triggers>
                                                        <Trigger Property="HasItems" Value="False">
                                                            <Setter Property="Visibility" Value="Collapsed" />
                                                        </Trigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </DataGrid.Style>

                                            <!--  style canh phải cho số  -->
                                            <DataGrid.Resources>
                                                <Style x:Key="RightCell" TargetType="TextBlock">
                                                    <Setter Property="TextAlignment" Value="Right" />
                                                    <Setter Property="Margin" Value="0,0,6,0" />
                                                </Style>
                                            </DataGrid.Resources>

                                            <DataGrid.RowStyle>
                                                <Style TargetType="DataGridRow">
                                                    <EventSetter Event="PreviewMouseLeftButtonDown" Handler="DataGridRow_PreviewMouseLeftButtonDown" />
                                                </Style>
                                            </DataGrid.RowStyle>

                                            <DataGrid.Columns>
                                                <DataGridTextColumn
                                                    Width="70"
                                                    Binding="{Binding Stt}"
                                                    ElementStyle="{StaticResource RightCell}"
                                                    Header="STT" />
                                                <DataGridTextColumn
                                                    Width="120"
                                                    Binding="{Binding Ma_Dich_Vu}"
                                                    Header="Mã DV" />
                                                <DataGridTextColumn Width="300" Header="Tên DV">
                                                    <DataGridTextColumn.ElementStyle>
                                                        <Style BasedOn="{StaticResource CellTextBlock}" TargetType="TextBlock" />
                                                    </DataGridTextColumn.ElementStyle>
                                                    <DataGridTextColumn.Binding>
                                                        <Binding Path="Ten_Dich_Vu" />
                                                    </DataGridTextColumn.Binding>
                                                </DataGridTextColumn>
                                                <DataGridTextColumn
                                                    Width="110"
                                                    Binding="{Binding So_Luong, StringFormat=N2}"
                                                    ElementStyle="{StaticResource RightCell}"
                                                    Header="SL" />
                                                <DataGridTextColumn
                                                    Width="130"
                                                    Binding="{Binding Don_Gia_Bh, StringFormat=N2}"
                                                    ElementStyle="{StaticResource RightCell}"
                                                    Header="Đơn giá BH" />
                                                <DataGridTextColumn
                                                    Width="140"
                                                    Binding="{Binding Thanh_Tien_Bh, StringFormat=N2}"
                                                    ElementStyle="{StaticResource RightCell}"
                                                    Header="Thành tiền BH" />
                                                <DataGridTextColumn
                                                    Width="130"
                                                    Binding="{Binding Ngay_Yl}"
                                                    Header="Ngày YL" />
                                            </DataGrid.Columns>

                                            <DataGrid.RowDetailsTemplate>
                                                <DataTemplate>
                                                    <Border
                                                        Margin="0,4,0,8"
                                                        Padding="10"
                                                        Background="#FFF9F9F9"
                                                        BorderBrush="#1F000000"
                                                        BorderThickness="1">
                                                        <ScrollViewer HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
                                                            <WrapPanel MinWidth="400" ItemWidth="260">
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="ID" />
                                                                    <TextBlock Text="{Binding Id}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Mã LK" />
                                                                    <TextBlock Text="{Binding Ma_Lk}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="STT" />
                                                                    <TextBlock Text="{Binding Stt}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Mã DV" />
                                                                    <TextBlock Foreground="{Binding Error.Ma_Dich_Vu, Converter={StaticResource ErrorToColor}}" Text="{Binding Ma_Dich_Vu}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Mã PTTT QT" />
                                                                    <TextBlock Text="{Binding Ma_Pttt_Qt}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Mã vật tư" />
                                                                    <TextBlock Text="{Binding Ma_Vat_Tu}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Mã nhóm" />
                                                                    <TextBlock Text="{Binding Ma_Nhom}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Gói VTYT" />
                                                                    <TextBlock Text="{Binding Goi_Vtyt}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Tên vật tư" />
                                                                    <TextBlock Text="{Binding Ten_Vat_Tu}" TextWrapping="Wrap" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Tên dịch vụ" />
                                                                    <TextBlock
                                                                        Foreground="{Binding Error.Ten_Dich_Vu, Converter={StaticResource ErrorToColor}}"
                                                                        Text="{Binding Ten_Dich_Vu}"
                                                                        TextWrapping="Wrap" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Mã xăng dầu" />
                                                                    <TextBlock Text="{Binding Ma_Xang_Dau}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Đơn vị tính" />
                                                                    <TextBlock Text="{Binding Don_Vi_Tinh}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Phạm vi" />
                                                                    <TextBlock Text="{Binding Pham_Vi}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Số lượng" />
                                                                    <TextBlock Text="{Binding So_Luong, StringFormat=N2}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Đơn giá BV" />
                                                                    <TextBlock Text="{Binding Don_Gia_Bv, StringFormat=N2}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Đơn giá BH" />
                                                                    <TextBlock Text="{Binding Don_Gia_Bh, StringFormat=N2}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="TT thầu" />
                                                                    <TextBlock Text="{Binding Tt_Thau}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Tỷ lệ TT DV" />
                                                                    <TextBlock Text="{Binding Tyle_Tt_Dv, StringFormat=N2}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Tỷ lệ TT BH" />
                                                                    <TextBlock Text="{Binding Tyle_Tt_Bh, StringFormat=N2}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Thành tiền BV" />
                                                                    <TextBlock Text="{Binding Thanh_Tien_Bv, StringFormat=N2}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Thành tiền BH" />
                                                                    <TextBlock Text="{Binding Thanh_Tien_Bh, StringFormat=N2}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Trần thanh toán" />
                                                                    <TextBlock Text="{Binding T_TranTt, StringFormat=N2}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Mức hưởng" />
                                                                    <TextBlock Text="{Binding Muc_Huong, StringFormat=N0}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="BNTT" />
                                                                    <TextBlock Text="{Binding T_Bntt, StringFormat=N2}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="BNCCT" />
                                                                    <TextBlock Text="{Binding T_Bncct, StringFormat=N2}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="BHTT" />
                                                                    <TextBlock Text="{Binding T_Bhtt, StringFormat=N2}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Mã khoa" />
                                                                    <TextBlock Text="{Binding Ma_Khoa}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Mã giường" />
                                                                    <TextBlock Text="{Binding Ma_Giuong}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Mã bác sĩ" />
                                                                    <TextBlock Text="{Binding Ma_Bac_Si}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Người thực hiện" />
                                                                    <TextBlock Text="{Binding Nguoi_Thuc_Hien}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Mã bệnh" />
                                                                    <TextBlock Text="{Binding Ma_Benh}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Mã bệnh YHCT" />
                                                                    <TextBlock Text="{Binding Ma_Benh_Yhct}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Ngày YL" />
                                                                    <TextBlock Text="{Binding Ngay_Yl}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Ngày TH YL" />
                                                                    <TextBlock Text="{Binding Ngay_Th_Yl}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Ngày KQ" />
                                                                    <TextBlock Text="{Binding Ngay_Kq}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Mã PTTT" />
                                                                    <TextBlock Text="{Binding Ma_Pttt}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Vết thương TP" />
                                                                    <TextBlock Text="{Binding Vet_Thuong_Tp}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="PP vô cảm" />
                                                                    <TextBlock Text="{Binding Pp_Vo_Cam}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Vị trí TH DVKT" />
                                                                    <TextBlock Text="{Binding Vi_Tri_Th_Dvkt}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Mã máy" />
                                                                    <TextBlock Text="{Binding Ma_May}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Mã hiệu SP" />
                                                                    <TextBlock Text="{Binding Ma_Hieu_Sp}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Tái sử dụng" />
                                                                    <TextBlock Text="{Binding Tai_Su_Dung}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Dự phòng" />
                                                                    <TextBlock Text="{Binding Du_Phong}" />
                                                                </StackPanel>
                                                            </WrapPanel>
                                                        </ScrollViewer>
                                                    </Border>
                                                </DataTemplate>
                                            </DataGrid.RowDetailsTemplate>
                                        </DataGrid>

                                        <!--  PLACEHOLDER khi rỗng/null  -->
                                        <Border
                                            Grid.Row="1"
                                            Padding="16"
                                            Background="Transparent">
                                            <TextBlock
                                                HorizontalAlignment="Center"
                                                VerticalAlignment="Center"
                                                Opacity="0.6"
                                                Text="Không có dữ liệu XML3." />
                                            <Border.Style>
                                                <Style TargetType="Border">
                                                    <Setter Property="Visibility" Value="Collapsed" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding ElementName=Xml3Grid, Path=HasItems}" Value="False">
                                                            <Setter Property="Visibility" Value="Visible" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Border.Style>
                                        </Border>
                                    </Grid>
                                </TabItem>

                                <TabItem Header="XML4">
                                    <Grid Margin="0,4,0,0">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="*" />
                                        </Grid.RowDefinitions>

                                        <TextBlock
                                            Grid.Row="0"
                                            Margin="0,0,0,6"
                                            FontWeight="SemiBold"
                                            Text="Danh sách CLS (XML4)" />
                                        <TextBlock
                                            Grid.Row="0"
                                            Margin="0,22,0,6"
                                            FontStyle="Italic"
                                            Opacity="0.6"
                                            Text="Chọn một dòng để xem đầy đủ chi tiết. Các cột đã được rút gọn để tránh phải kéo ngang." />

                                        <!--  DATA GRID  -->
                                        <DataGrid
                                            x:Name="Xml4Grid"
                                            Grid.Row="1"
                                            AlternatingRowBackground="#11000000"
                                            AutoGenerateColumns="False"
                                            CanUserAddRows="False"
                                            CanUserDeleteRows="False"
                                            ColumnWidth="Auto"
                                            GridLinesVisibility="None"
                                            HeadersVisibility="Column"
                                            IsReadOnly="True"
                                            ItemsSource="{Binding Xml4}"
                                            MinColumnWidth="80"
                                            RowDetailsVisibilityMode="VisibleWhenSelected"
                                            ScrollViewer.HorizontalScrollBarVisibility="Auto"
                                            ScrollViewer.VerticalScrollBarVisibility="Auto">

                                            <!--  Ẩn DataGrid khi rỗng  -->
                                            <DataGrid.Style>
                                                <Style TargetType="DataGrid">
                                                    <Setter Property="Visibility" Value="Visible" />
                                                    <Style.Triggers>
                                                        <Trigger Property="HasItems" Value="False">
                                                            <Setter Property="Visibility" Value="Collapsed" />
                                                        </Trigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </DataGrid.Style>

                                            <DataGrid.RowStyle>
                                                <Style TargetType="DataGridRow" />
                                            </DataGrid.RowStyle>

                                            <DataGrid.Columns>
                                                <DataGridTextColumn
                                                    Width="70"
                                                    Binding="{Binding Stt}"
                                                    Header="STT" />
                                                <DataGridTextColumn
                                                    Width="120"
                                                    Binding="{Binding Ma_Dich_Vu}"
                                                    Header="Mã DV" />
                                                <DataGridTextColumn Width="300" Header="Tên chỉ số">
                                                    <DataGridTextColumn.ElementStyle>
                                                        <Style BasedOn="{StaticResource CellTextBlock}" TargetType="TextBlock" />
                                                    </DataGridTextColumn.ElementStyle>
                                                    <DataGridTextColumn.Binding>
                                                        <Binding Path="Ten_Chi_So" />
                                                    </DataGridTextColumn.Binding>
                                                </DataGridTextColumn>
                                                <DataGridTextColumn
                                                    Width="150"
                                                    Binding="{Binding Gia_Tri}"
                                                    Header="Giá trị" />
                                                <DataGridTextColumn
                                                    Width="100"
                                                    Binding="{Binding Don_Vi_Do}"
                                                    Header="Đơn vị" />
                                                <DataGridTextColumn
                                                    Width="200"
                                                    Binding="{Binding Ket_Luan}"
                                                    Header="Kết luận" />
                                                <DataGridTextColumn
                                                    Width="130"
                                                    Binding="{Binding Ngay_Kq}"
                                                    Header="Ngày KQ" />
                                            </DataGrid.Columns>

                                            <DataGrid.RowDetailsTemplate>
                                                <DataTemplate>
                                                    <Border
                                                        Margin="0,4,0,8"
                                                        Padding="10"
                                                        Background="#FFF9F9F9"
                                                        BorderBrush="#1F000000"
                                                        BorderThickness="1">
                                                        <ScrollViewer HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
                                                            <WrapPanel MinWidth="400" ItemWidth="260">
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="ID" />
                                                                    <TextBlock Text="{Binding Id}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Mã LK" />
                                                                    <TextBlock Text="{Binding Ma_Lk}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="STT" />
                                                                    <TextBlock Text="{Binding Stt}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Mã dịch vụ" />
                                                                    <TextBlock Foreground="{Binding Error.Ma_Dich_Vu, Converter={StaticResource ErrorToColor}}" Text="{Binding Ma_Dich_Vu}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Mã chỉ số" />
                                                                    <TextBlock Text="{Binding Ma_Chi_So}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Tên chỉ số" />
                                                                    <TextBlock
                                                                        Foreground="{Binding Error.Ten_Chi_So, Converter={StaticResource ErrorToColor}}"
                                                                        Text="{Binding Ten_Chi_So}"
                                                                        TextWrapping="Wrap" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Giá trị" />
                                                                    <TextBlock Text="{Binding Gia_Tri}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Đơn vị đo" />
                                                                    <TextBlock Text="{Binding Don_Vi_Do}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Mô tả" />
                                                                    <TextBlock Text="{Binding Mo_Ta}" TextWrapping="Wrap" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Kết luận" />
                                                                    <TextBlock Text="{Binding Ket_Luan}" TextWrapping="Wrap" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Ngày KQ" />
                                                                    <TextBlock Text="{Binding Ngay_Kq}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Mã BS đọc KQ" />
                                                                    <TextBlock Text="{Binding Ma_Bs_Doc_Kq}" />
                                                                </StackPanel>
                                                                <StackPanel Margin="6">
                                                                    <TextBlock FontWeight="SemiBold" Text="Dự phòng" />
                                                                    <TextBlock Text="{Binding Du_Phong}" />
                                                                </StackPanel>
                                                            </WrapPanel>
                                                        </ScrollViewer>
                                                    </Border>
                                                </DataTemplate>
                                            </DataGrid.RowDetailsTemplate>
                                        </DataGrid>


                                        <Border
                                            Grid.Row="1"
                                            Padding="16"
                                            Background="Transparent">
                                            <TextBlock
                                                HorizontalAlignment="Center"
                                                VerticalAlignment="Center"
                                                Opacity="0.6"
                                                Text="Không có dữ liệu XML4." />
                                            <Border.Style>
                                                <Style TargetType="Border">
                                                    <Setter Property="Visibility" Value="Collapsed" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding ElementName=Xml4Grid, Path=HasItems}" Value="False">
                                                            <Setter Property="Visibility" Value="Visible" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Border.Style>
                                        </Border>
                                    </Grid>
                                </TabItem>

                                <TabItem Header="XML5">
                                    <Grid Height="140">
                                        <TextBlock
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            Opacity="0.6"
                                            Text="Đang cập nhật…" />
                                    </Grid>
                                </TabItem>
                                <TabItem Header="XML6">
                                    <Grid Height="140">
                                        <TextBlock
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            Opacity="0.6"
                                            Text="Đang cập nhật…" />
                                    </Grid>
                                </TabItem>
                                <TabItem Header="XML7">
                                    <Grid Height="140">
                                        <TextBlock
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            Opacity="0.6"
                                            Text="Đang cập nhật…" />
                                    </Grid>
                                </TabItem>
                                <TabItem Header="XML8">
                                    <Grid Height="140">
                                        <TextBlock
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            Opacity="0.6"
                                            Text="Đang cập nhật…" />
                                    </Grid>
                                </TabItem>
                                <TabItem Header="XML9">
                                    <Grid Height="140">
                                        <TextBlock
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            Opacity="0.6"
                                            Text="Đang cập nhật…" />
                                    </Grid>
                                </TabItem>
                                <TabItem Header="XML10">
                                    <Grid Height="140">
                                        <TextBlock
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            Opacity="0.6"
                                            Text="Đang cập nhật…" />
                                    </Grid>
                                </TabItem>
                                <TabItem Header="XML11">
                                    <Grid Height="140">
                                        <TextBlock
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            Opacity="0.6"
                                            Text="Đang cập nhật…" />
                                    </Grid>
                                </TabItem>
                                <TabItem Header="XML13">
                                    <Grid Height="140">
                                        <TextBlock
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            Opacity="0.6"
                                            Text="Đang cập nhật…" />
                                    </Grid>
                                </TabItem>
                                <TabItem Header="XML14">
                                    <Grid Height="140">
                                        <TextBlock
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            Opacity="0.6"
                                            Text="Đang cập nhật…" />
                                    </Grid>
                                </TabItem>
                                <TabItem Header="XML15">
                                    <Grid Height="140">
                                        <TextBlock
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            Opacity="0.6"
                                            Text="Đang cập nhật…" />
                                    </Grid>
                                </TabItem>
                                <TabItem Header="Các lỗi mắc phải">
                                    <Grid Margin="16">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="*" />
                                        </Grid.RowDefinitions>

                                        <!--  Header với icon và title  -->
                                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,16">
                                            <materialDesign:PackIcon 
                                                Kind="AlertCircle" 
                                                Width="24" 
                                                Height="24" 
                                                VerticalAlignment="Center"
                                                Foreground="{DynamicResource MaterialDesignValidationErrorBrush}" />
                                            <TextBlock
                                                Margin="8,0,0,0"
                                                VerticalAlignment="Center"
                                                FontSize="18"
                                                FontWeight="SemiBold"
                                                Text="Các lỗi mắc phải" />
                                        </StackPanel>

                                        <!--  Stats Cards  -->
                                        <Grid Grid.Row="1" Margin="0,0,0,16">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="*" />
                                            </Grid.ColumnDefinitions>

                                            <!--  Total Errors Card  -->
                                            <Border 
                                                Grid.Column="0" 
                                                Margin="0,0,8,0"
                                                Padding="16"
                                                Background="{DynamicResource MaterialDesignCardBackground}"
                                                BorderBrush="{DynamicResource MaterialDesignDivider}"
                                                BorderThickness="1"
                                                CornerRadius="8">
                                                <StackPanel>
                                                    <TextBlock 
                                                        FontSize="24" 
                                                        FontWeight="Bold"
                                                        Foreground="{DynamicResource MaterialDesignValidationErrorBrush}"
                                                        Text="{Binding ActivatedErrors.Count, Mode=OneWay}" />
                                                    <TextBlock 
                                                        FontSize="12" 
                                                        Foreground="{DynamicResource SecondaryTextBrush}"
                                                        Text="Tổng lỗi" />
                                                </StackPanel>
                                            </Border>

                                            <!--  XML1 Errors Card  -->
                                            <Border 
                                                Grid.Column="1" 
                                                Margin="4,0"
                                                Padding="16"
                                                Background="{DynamicResource MaterialDesignCardBackground}"
                                                BorderBrush="{DynamicResource MaterialDesignDivider}"
                                                BorderThickness="1"
                                                CornerRadius="8">
                                                <StackPanel>
                                                    <TextBlock 
                                                        FontSize="24" 
                                                        FontWeight="Bold"
                                                        Foreground="{DynamicResource MaterialDesignBodyLight}"
                                                        Text="{Binding ActivatedErrors, Mode=OneWay, Converter={StaticResource Xml1ErrorCountConverter}}" />
                                                    <TextBlock 
                                                        FontSize="12" 
                                                        Foreground="{DynamicResource SecondaryTextBrush}"
                                                        Text="XML1" />
                                                </StackPanel>
                                            </Border>

                                            <!--  XML2 Errors Card  -->
                                            <Border 
                                                Grid.Column="2" 
                                                Margin="4,0"
                                                Padding="16"
                                                Background="{DynamicResource MaterialDesignCardBackground}"
                                                BorderBrush="{DynamicResource MaterialDesignDivider}"
                                                BorderThickness="1"
                                                CornerRadius="8">
                                                <StackPanel>
                                                    <TextBlock 
                                                        FontSize="24" 
                                                        FontWeight="Bold"
                                                        Foreground="{DynamicResource MaterialDesignBodyLight}"
                                                        Text="{Binding ActivatedErrors, Mode=OneWay, Converter={StaticResource Xml2ErrorCountConverter}}" />
                                                    <TextBlock 
                                                        FontSize="12" 
                                                        Foreground="{DynamicResource SecondaryTextBrush}"
                                                        Text="XML2" />
                                                </StackPanel>
                                            </Border>

                                            <!--  XML3 Errors Card  -->
                                            <Border 
                                                Grid.Column="3" 
                                                Margin="4,0,0,0"
                                                Padding="16"
                                                Background="{DynamicResource MaterialDesignCardBackground}"
                                                BorderBrush="{DynamicResource MaterialDesignDivider}"
                                                BorderThickness="1"
                                                CornerRadius="8">
                                                <StackPanel>
                                                    <TextBlock 
                                                        FontSize="24" 
                                                        FontWeight="Bold"
                                                        Foreground="{DynamicResource MaterialDesignBodyLight}"
                                                        Text="{Binding ActivatedErrors, Mode=OneWay, Converter={StaticResource Xml3ErrorCountConverter}}" />
                                                    <TextBlock 
                                                        FontSize="12" 
                                                        Foreground="{DynamicResource SecondaryTextBrush}"
                                                        Text="XML3" />
                                                </StackPanel>
                                            </Border>
                                        </Grid>

                                        <!--  Error List  -->
                                        <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
                                            <ItemsControl ItemsSource="{Binding ActivatedErrors, Mode=OneWay}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border
                                                            Margin="0,0,0,12"
                                                            Padding="20"
                                                            Background="{DynamicResource MaterialDesignCardBackground}"
                                                            BorderBrush="{DynamicResource MaterialDesignDivider}"
                                                            BorderThickness="1"
                                                            CornerRadius="12"
                                                            Effect="{DynamicResource MaterialDesignElevationShadow2}">
                                                            <Grid>
                                                                <Grid.RowDefinitions>
                                                                    <RowDefinition Height="Auto" />
                                                                    <RowDefinition Height="Auto" />
                                                                    <RowDefinition Height="Auto" />
                                                                </Grid.RowDefinitions>
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="Auto" />
                                                                    <ColumnDefinition Width="*" />
                                                                    <ColumnDefinition Width="Auto" />
                                                                </Grid.ColumnDefinitions>

                                                                <!--  STT Badge  -->
                                                                <Border
                                                                    Grid.Row="0" 
                                                                    Grid.Column="0"
                                                                    Grid.RowSpan="2"
                                                                    Margin="0,0,16,0"
                                                                    Width="40"
                                                                    Height="40"
                                                                    Background="{DynamicResource MaterialDesignValidationErrorBrush}"
                                                                    CornerRadius="20">
                                                                    <TextBlock
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        FontSize="14"
                                                                        FontWeight="Bold"
                                                                        Foreground="White"
                                                                        Text="{Binding Stt}" />
                                                                </Border>

                                                                <!--  Error Content  -->
                                                                <StackPanel Grid.Row="0" Grid.Column="1" Grid.ColumnSpan="2">
                                                                    <!--  Main Error Message  -->
                                                                    <TextBlock
                                                                        FontSize="15"
                                                                        FontWeight="SemiBold"
                                                                        Foreground="{DynamicResource MaterialDesignBodyLight}"
                                                                        Text="{Binding NoiDung}"
                                                                        TextWrapping="Wrap"
                                                                        LineHeight="20" />
                                                                    
                                                                    <!--  Error Details  -->
                                                                    <StackPanel Margin="0,8,0,0" Orientation="Horizontal">
                                                                        <!--  ViTriLoi Badge  -->
                                                                        <Border
                                                                            Margin="0,0,8,0"
                                                                            Padding="6,2"
                                                                            Background="{DynamicResource MaterialDesignChipBackground}"
                                                                            CornerRadius="12">
                                                                            <TextBlock
                                                                                FontSize="10"
                                                                                FontWeight="Medium"
                                                                                Foreground="{DynamicResource MaterialDesignChipForeground}"
                                                                                Text="{Binding ViTriLoi}" />
                                                                        </Border>
                                                                        
                                                                        <!--  MaChuyenDe Badge  -->
                                                                        <Border
                                                                            Margin="0,0,8,0"
                                                                            Padding="6,2"
                                                                            Background="{DynamicResource MaterialDesignChipBackground}"
                                                                            CornerRadius="12">
                                                                            <TextBlock
                                                                                FontSize="10"
                                                                                FontWeight="Medium"
                                                                                Foreground="{DynamicResource MaterialDesignChipForeground}"
                                                                                Text="{Binding MaChuyenDe}" />
                                                                        </Border>
                                                                    </StackPanel>
                                                                </StackPanel>

                                                                <!--  MaCoSoKCB  -->
                                                                <TextBlock
                                                                    Grid.Row="1" 
                                                                    Grid.Column="2"
                                                                    Margin="16,0,0,0"
                                                                    VerticalAlignment="Bottom"
                                                                    FontSize="11"
                                                                    FontWeight="Medium"
                                                                    Foreground="{DynamicResource SecondaryTextBrush}"
                                                                    Text="{Binding MaCoSoKCB}" />

                                                                <!--  MaLyDoTuChoi  -->
                                                                <TextBlock
                                                                    Grid.Row="2" 
                                                                    Grid.Column="1"
                                                                    Grid.ColumnSpan="2"
                                                                    Margin="56,8,0,0"
                                                                    FontSize="12"
                                                                    FontStyle="Italic"
                                                                    Foreground="{DynamicResource SecondaryTextBrush}"
                                                                    Text="{Binding MaLyDoTuChoi}" />
                                                            </Grid>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </ScrollViewer>
                                    </Grid>
                                </TabItem>
                            </TabControl>
                        </Border>
                    </DataTemplate>
                </DataGrid.RowDetailsTemplate>
            </DataGrid>

            <!--  LOADING  -->
            <Border Background="#66FFFFFF" Visibility="{Binding IsLoading, Converter={StaticResource BoolToVis}}">
                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                    <ProgressBar
                        Width="220"
                        Height="6"
                        IsIndeterminate="True" />
                    <TextBlock Margin="0,8,0,0" Text="Đang tải dữ liệu..." />
                </StackPanel>
            </Border>

            <!--  EMPTY  -->
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <StackPanel.Style>
                    <Style TargetType="StackPanel">
                        <Setter Property="Visibility" Value="Collapsed" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding HasItems, ElementName=PatientsGrid}" Value="False">
                                <Setter Property="Visibility" Value="Visible" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </StackPanel.Style>

                <materialDesign:PackIcon
                    Width="48"
                    Height="48"
                    Kind="DatabaseSearch"
                    Opacity="0.6" />
                <TextBlock
                    Margin="0,8,0,0"
                    Opacity="0.7"
                    Text="Chưa có dữ liệu. Nhập số bệnh án/số tiếp nhận rồi Tra cứu." />
            </StackPanel>
        </Grid>
    </Grid>
</UserControl>
