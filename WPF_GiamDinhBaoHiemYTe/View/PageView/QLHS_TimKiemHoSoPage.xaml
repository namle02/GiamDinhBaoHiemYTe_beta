<UserControl
    x:Class="WPF_GiamDinhBaoHiem.View.PageView.QLHS_TimKiemHoSoPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:converter="clr-namespace:WPF_GiamDinhBaoHiem.Converter"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    x:Name="Root"
    Background="{DynamicResource MaterialDesignPaper}"
    mc:Ignorable="d">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis" />
        <converter:StringToVisibilityConverter x:Key="StringToVis" />
        <converter:ErrorToColorConverter x:Key="ErrorToColorConverter" />
        <converter:ErrorContentToColorConverter x:Key="ErrorContentToColorConverter" />
        <converter:ErrorContentBackgroundConverter x:Key="ErrorContentBackgroundConverter" />
        <converter:ErrorContentBorderConverter x:Key="ErrorContentBorderConverter" />
        <converter:FieldErrorConverter x:Key="FieldErrorConverter" />
        <converter:GenderConverter x:Key="GenderConverter" />
        <converter:ErrorTextConverter x:Key="ErrorTextConverter" />

        <!-- Style cho TextBlock trong XML2-5 để có màu đỏ khi lỗi -->
        <Style x:Key="ErrorTextBlockStyle" TargetType="TextBlock">
            <Setter Property="Foreground">
                <Setter.Value>
                    <MultiBinding Converter="{StaticResource ErrorTextConverter}">
                        <Binding Path="Id" />
                        <Binding Path="DataContext.OverlayErrorIds" RelativeSource="{RelativeSource AncestorType=UserControl}" />
                    </MultiBinding>
                </Setter.Value>
            </Setter>
        </Style>


        <Style x:Key="CellTextBlock" TargetType="TextBlock">
            <Setter Property="TextTrimming" Value="CharacterEllipsis" />
            <Setter Property="ToolTip" Value="{Binding Text, RelativeSource={RelativeSource Self}}" />
            <Setter Property="VerticalAlignment" Value="Center" />
        </Style>

        <Style x:Key="ChipCount" TargetType="Border">
            <Setter Property="CornerRadius" Value="10" />
            <Setter Property="Padding" Value="6,2" />
            <Setter Property="Background" Value="{DynamicResource PrimaryHueLightBrush}" />
            <Setter Property="BorderBrush" Value="{DynamicResource PrimaryHueMidBrush}" />
            <Setter Property="BorderThickness" Value="1" />
        </Style>

        <Style TargetType="DataGridColumnHeader">
            <Setter Property="HorizontalContentAlignment" Value="Center" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="Background" Value="#FAFAFA" />
            <Setter Property="Padding" Value="8,6" />
        </Style>

        <Style TargetType="DataGrid">
            <Setter Property="RowHeaderWidth" Value="0" />
            <Setter Property="AlternatingRowBackground" Value="#11000000" />
            <Setter Property="AlternationCount" Value="2" />
            <Setter Property="GridLinesVisibility" Value="None" />
            <Setter Property="EnableRowVirtualization" Value="True" />
            <Setter Property="EnableColumnVirtualization" Value="True" />
        </Style>

        <!--  Pastel header colors per XML tab  -->
        <SolidColorBrush x:Key="Xml1Header" Color="#E6F4FF" />
        <SolidColorBrush x:Key="Xml2Header" Color="#FFF5E6" />
        <SolidColorBrush x:Key="Xml3Header" Color="#E8FFF3" />
        <SolidColorBrush x:Key="Xml4Header" Color="#FDEDF2" />
        <SolidColorBrush x:Key="Xml5Header" Color="#F3FDE8" />
        <SolidColorBrush x:Key="Xml6Header" Color="#EDEBFF" />
        <SolidColorBrush x:Key="Xml7Header" Color="#FFEFE6" />
        <SolidColorBrush x:Key="Xml8Header" Color="#E6FFF9" />
        <SolidColorBrush x:Key="Xml9Header" Color="#FFF0F5" />
        <SolidColorBrush x:Key="Xml10Header" Color="#FFFBE6" />
        <SolidColorBrush x:Key="Xml11Header" Color="#EAF2FF" />
        <SolidColorBrush x:Key="Xml12Header" Color="#F6E6FF" />
        <SolidColorBrush x:Key="Xml13Header" Color="#E6FFF0" />
        <SolidColorBrush x:Key="Xml14Header" Color="#FFE6F2" />
        <SolidColorBrush x:Key="Xml15Header" Color="#E6F0FF" />
        <SolidColorBrush x:Key="XmlDefaultHeader" Color="#F3F4F6" />

        <!--  Colored TabItem header style  -->
        <Style x:Key="ColoredTabItem" TargetType="TabItem">
            <Setter Property="Margin" Value="2,0,2,0" />
            <Setter Property="Padding" Value="8,4" />
            <Setter Property="Background" Value="{StaticResource XmlDefaultHeader}" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TabItem">
                        <Border
                            x:Name="Bd"
                            Padding="0"
                            Background="{TemplateBinding Background}"
                            BorderBrush="#D1D5DB"
                            BorderThickness="1"
                            CornerRadius="6,6,0,0">
                            <ContentPresenter
                                x:Name="Content"
                                Margin="10,4"
                                ContentSource="Header"
                                RecognizesAccessKey="True" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Bd" Property="BorderBrush" Value="#9CA3AF" />
                                <Setter TargetName="Bd" Property="RenderOptions.BitmapScalingMode" Value="HighQuality" />
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.6" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <!--  XML1 Tab Error Highlighting  -->
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML1" />
                        <Condition Binding="{Binding DataContext.HasXml1Error, RelativeSource={RelativeSource AncestorType=Page}}" Value="True" />
                    </MultiDataTrigger.Conditions>
                    <Setter Property="Background" Value="Red" />
                    <Setter Property="Foreground" Value="White" />
                </MultiDataTrigger>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML1">
                    <Setter Property="Background" Value="{StaticResource Xml1Header}" />
                </DataTrigger>

                <!--  XML2 Tab Error Highlighting  -->
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML2" />
                        <Condition Binding="{Binding DataContext.HasOverlayXml2Error, RelativeSource={RelativeSource AncestorType=Page}}" Value="True" />
                    </MultiDataTrigger.Conditions>
                    <Setter Property="Background" Value="Red" />
                    <Setter Property="Foreground" Value="White" />
                </MultiDataTrigger>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML2">
                    <Setter Property="Background" Value="{StaticResource Xml2Header}" />
                </DataTrigger>

                <!--  XML3 Tab Error Highlighting  -->
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML3" />
                        <Condition Binding="{Binding DataContext.HasOverlayXml3Error, RelativeSource={RelativeSource AncestorType=Page}}" Value="True" />
                    </MultiDataTrigger.Conditions>
                    <Setter Property="Background" Value="Red" />
                    <Setter Property="Foreground" Value="White" />
                </MultiDataTrigger>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML3">
                    <Setter Property="Background" Value="{StaticResource Xml3Header}" />
                </DataTrigger>

                <!--  XML4 Tab Error Highlighting  -->
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML4" />
                        <Condition Binding="{Binding DataContext.HasOverlayXml4Error, RelativeSource={RelativeSource AncestorType=Page}}" Value="True" />
                    </MultiDataTrigger.Conditions>
                    <Setter Property="Background" Value="Red" />
                    <Setter Property="Foreground" Value="White" />
                </MultiDataTrigger>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML4">
                    <Setter Property="Background" Value="{StaticResource Xml4Header}" />
                </DataTrigger>

                <!--  XML5 Tab Error Highlighting  -->
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML5" />
                        <Condition Binding="{Binding DataContext.HasOverlayXml5Error, RelativeSource={RelativeSource AncestorType=Page}}" Value="True" />
                    </MultiDataTrigger.Conditions>
                    <Setter Property="Background" Value="Red" />
                    <Setter Property="Foreground" Value="White" />
                </MultiDataTrigger>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML5">
                    <Setter Property="Background" Value="{StaticResource Xml5Header}" />
                </DataTrigger>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML6">
                    <Setter Property="Background" Value="{StaticResource Xml6Header}" />
                </DataTrigger>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML7">
                    <Setter Property="Background" Value="{StaticResource Xml7Header}" />
                </DataTrigger>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML8">
                    <Setter Property="Background" Value="{StaticResource Xml8Header}" />
                </DataTrigger>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML9">
                    <Setter Property="Background" Value="{StaticResource Xml9Header}" />
                </DataTrigger>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML10">
                    <Setter Property="Background" Value="{StaticResource Xml10Header}" />
                </DataTrigger>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML11">
                    <Setter Property="Background" Value="{StaticResource Xml11Header}" />
                </DataTrigger>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML12">
                    <Setter Property="Background" Value="{StaticResource Xml12Header}" />
                </DataTrigger>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML13">
                    <Setter Property="Background" Value="{StaticResource Xml13Header}" />
                </DataTrigger>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML14">
                    <Setter Property="Background" Value="{StaticResource Xml14Header}" />
                </DataTrigger>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self}, Path=Header}" Value="XML15">
                    <Setter Property="Background" Value="{StaticResource Xml15Header}" />
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <Grid>
        <!--  NỘI DUNG CHÍNH  -->
        <Grid Margin="16">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="8" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!--  SEARCH  -->
            <materialDesign:Card Padding="16">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <TextBox
                        x:Name="SearchTextBox"
                        Grid.Column="0"
                        MinHeight="48"
                        Margin="0,0,8,0"
                        VerticalContentAlignment="Center"
                        materialDesign:HintAssist.Hint="Nhập số bệnh án / số tiếp nhận rồi nhấn Enter"
                        materialDesign:TextFieldAssist.HasClearButton="True"
                        FontSize="18"
                        Style="{StaticResource MaterialDesignOutlinedTextBox}"
                        Text="{Binding PatientID, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}">
                        <TextBox.InputBindings>
                            <KeyBinding
                                Key="Enter"
                                Command="{Binding SearchCommand}"
                                CommandParameter="{Binding PatientID}" />
                        </TextBox.InputBindings>

                    </TextBox>
                    <Button
                        Grid.Column="1"
                        Height="48"
                        MinWidth="140"
                        Margin="8,5,8,5"
                        Command="{Binding SearchCommand}"
                        CommandParameter="{Binding Text, ElementName=SearchTextBox}">
                        <StackPanel VerticalAlignment="Center" Orientation="Horizontal">
                            <materialDesign:PackIcon
                                Width="20"
                                Height="20"
                                Margin="0,0,8,0"
                                Kind="Search" />
                            <TextBlock FontSize="16" Text="Tra cứu" />
                        </StackPanel>
                    </Button>

                    <StackPanel
                        Grid.Column="2"
                        Margin="8,0,0,0"
                        VerticalAlignment="Center"
                        Orientation="Horizontal">




                        <Button
                            Height="48"
                            MinWidth="120"
                            Margin="8,0,0,0"
                            Command="{Binding ImportExcelAndProcessCommand}"
                            Style="{StaticResource MaterialDesignOutlinedButton}">
                            <StackPanel VerticalAlignment="Center" Orientation="Horizontal">
                                <materialDesign:PackIcon
                                    Width="16"
                                    Height="16"
                                    Margin="0,0,4,0"
                                    Kind="FileExcel" />
                                <TextBlock FontSize="14" Text="Import Excel" />
                            </StackPanel>
                        </Button>
                        <Button
                            Height="48"
                            MinWidth="100"
                            Margin="8,0,0,0"
                            Command="{Binding ClearAllCacheCommand}"
                            Style="{StaticResource MaterialDesignOutlinedButton}">
                            <StackPanel VerticalAlignment="Center" Orientation="Horizontal">
                                <materialDesign:PackIcon
                                    Width="16"
                                    Height="16"
                                    Margin="0,0,4,0"
                                    Kind="Refresh" />
                                <TextBlock FontSize="14" Text="Làm mới" />
                            </StackPanel>
                        </Button>
                        <Border Style="{StaticResource ChipCount}">
                            <TextBlock>
                                <Run Text="Kết quả: " />
                                <Run Text="{Binding ValidationResults.Count, Mode=OneWay}" />
                            </TextBlock>
                        </Border>
                    </StackPanel>
                </Grid>
            </materialDesign:Card>

            <Border Grid.Row="1" />

            <!--  BATCH PROCESSING PROGRESS  -->
            <materialDesign:Card
                Grid.Row="1"
                Margin="0,8,0,0"
                Padding="16"
                Visibility="{Binding IsBatchProcessing, Converter={StaticResource BoolToVis}}">
                <StackPanel>
                    <TextBlock
                        Margin="0,0,0,8"
                        FontSize="16"
                        FontWeight="SemiBold"
                        Text="{Binding BatchStatus}" />
                    <ProgressBar
                        Height="8"
                        Maximum="{Binding BatchTotal}"
                        Value="{Binding BatchProgress}"
                        Style="{StaticResource MaterialDesignLinearProgressBar}" />
                    <TextBlock
                        Margin="0,4,0,0"
                        HorizontalAlignment="Right"
                        FontSize="12"
                        Foreground="{DynamicResource MaterialDesignBodyLight}"
                        TextAlignment="Right">
                        <TextBlock.Text>
                            <MultiBinding StringFormat="{}{0} / {1}">
                                <Binding Path="BatchProgress" />
                                <Binding Path="BatchTotal" />
                            </MultiBinding>
                        </TextBlock.Text>
                    </TextBlock>
                </StackPanel>
            </materialDesign:Card>

            <!--  RESULTS SECTION  -->
            <Grid Grid.Row="2">
                <!--  RESULTS SECTION with synchronized scrolling  -->
                <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <!--  Table Header  -->
                        <materialDesign:Card Margin="0,0,0,4" Padding="12,8">
                            <materialDesign:Card.Style>
                                <Style TargetType="materialDesign:Card">
                                    <Setter Property="Visibility" Value="Visible" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding ValidationResults.Count}" Value="0">
                                            <Setter Property="Visibility" Value="Collapsed" />
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding IsLoading}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </materialDesign:Card.Style>

                            <Grid MinWidth="800">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="180" />
                                    <ColumnDefinition Width="220" />
                                    <ColumnDefinition Width="120" />
                                    <ColumnDefinition Width="160" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="80" />
                                </Grid.ColumnDefinitions>

                                <TextBlock
                                    Grid.Column="0"
                                    FontWeight="Bold"
                                    Foreground="{DynamicResource PrimaryHueMidBrush}"
                                    Text="Mã liên kết" />
                                <TextBlock
                                    Grid.Column="1"
                                    FontWeight="Bold"
                                    Foreground="{DynamicResource PrimaryHueMidBrush}"
                                    Text="Họ và tên" />
                                <TextBlock
                                    Grid.Column="2"
                                    HorizontalAlignment="Center"
                                    FontWeight="Bold"
                                    Foreground="{DynamicResource PrimaryHueMidBrush}"
                                    Text="Giới tính" />
                                <TextBlock
                                    Grid.Column="3"
                                    HorizontalAlignment="Center"
                                    FontWeight="Bold"
                                    Foreground="{DynamicResource PrimaryHueMidBrush}"
                                    Text="Ngày sinh" />
                                <TextBlock
                                    Grid.Column="4"
                                    FontWeight="Bold"
                                    Foreground="{DynamicResource PrimaryHueMidBrush}"
                                    Text="Nội dung lỗi" />
                                <TextBlock
                                    Grid.Column="5"
                                    HorizontalAlignment="Center"
                                    FontWeight="Bold"
                                    Foreground="{DynamicResource PrimaryHueMidBrush}"
                                    Text="Chi tiết" />
                            </Grid>
                        </materialDesign:Card>

                        <!--  Results List  -->
                        <ItemsControl
                            x:Name="ResultsItemsControl"
                            MinWidth="800"
                            ItemsSource="{Binding ValidationResults}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <materialDesign:Card Margin="0,0,0,6" Padding="0">
                                        <Border
                                            Background="Transparent"
                                            BorderBrush="#E0E0E0"
                                            BorderThickness="0,0,0,1">
                                            <Grid Margin="12,10">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="180" />
                                                    <ColumnDefinition Width="220" />
                                                    <ColumnDefinition Width="120" />
                                                    <ColumnDefinition Width="160" />
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="80" />
                                                </Grid.ColumnDefinitions>

                                                <!--  Mã liên kết  -->
                                                <ContentControl Grid.Column="0">
                                                    <TextBlock
                                                        VerticalAlignment="Center"
                                                        FontWeight="Medium"
                                                        Style="{StaticResource CellTextBlock}"
                                                        Text="{Binding Ma_Lk}" />
                                                </ContentControl>

                                                <!--  Họ tên  -->
                                                <ContentControl Grid.Column="1">
                                                    <TextBlock
                                                        VerticalAlignment="Center"
                                                        FontWeight="SemiBold"
                                                        Style="{StaticResource CellTextBlock}"
                                                        Text="{Binding Ho_Ten}" />
                                                </ContentControl>

                                                <!--  Giới tính  -->
                                                <ContentControl Grid.Column="2">
                                                    <Border
                                                        Padding="12,4"
                                                        HorizontalAlignment="Center"
                                                        VerticalAlignment="Center"
                                                        Background="#E3F2FD"
                                                        CornerRadius="12">
                                                        <TextBlock
                                                            FontSize="13"
                                                            FontWeight="Medium"
                                                            Text="{Binding Gioi_Tinh}" />
                                                    </Border>
                                                </ContentControl>

                                                <!--  Ngày sinh  -->
                                                <ContentControl Grid.Column="3">
                                                    <TextBlock
                                                        HorizontalAlignment="Center"
                                                        VerticalAlignment="Center"
                                                        Style="{StaticResource CellTextBlock}"
                                                        Text="{Binding Nam_Sinh}" />
                                                </ContentControl>

                                                <!--  Nội dung lỗi  -->
                                                <ContentControl Grid.Column="4">
                                                    <Border
                                                        Padding="10,6"
                                                        Background="{Binding IsError, Converter={StaticResource ErrorContentBackgroundConverter}}"
                                                        BorderBrush="{Binding IsError, Converter={StaticResource ErrorContentBorderConverter}}"
                                                        BorderThickness="1"
                                                        CornerRadius="6">
                                                        <TextBlock
                                                            VerticalAlignment="Center"
                                                            FontSize="13"
                                                            Foreground="{Binding IsError, Converter={StaticResource ErrorContentToColorConverter}}"
                                                            Text="{Binding Noi_Dung_Loi}"
                                                            TextWrapping="Wrap" />
                                                    </Border>
                                                </ContentControl>

                                                <!--  Nút để xem chi tiết  -->
                                                <ContentControl Grid.Column="5">
                                                    <Button
                                                        Width="40"
                                                        Height="40"
                                                        Padding="0"
                                                        Background="green"
                                                        BorderBrush="#1976D2"
                                                        BorderThickness="1"
                                                        Command="{Binding DataContext.ShowErrorDetailsCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                        CommandParameter="{Binding}"
                                                        ToolTip="Xem chi tiết lỗi">
                                                        <materialDesign:PackIcon
                                                            Width="20"
                                                            Height="20"
                                                            Foreground="White"
                                                            Kind="Eye" />
                                                    </Button>
                                                </ContentControl>
                                            </Grid>

                                            <!--  Hover effect  -->
                                            <Border.Style>
                                                <Style TargetType="Border">
                                                    <Style.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter Property="Background" Value="#F5F5F5" />
                                                        </Trigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Border.Style>
                                        </Border>
                                    </materialDesign:Card>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </ScrollViewer>
                <!--  EMPTY STATE -  -->
                <ContentControl>
                    <ContentControl.Style>
                        <Style TargetType="ContentControl">
                            <Setter Property="Visibility" Value="Collapsed" />
                            <Style.Triggers>
                                <MultiDataTrigger>
                                    <MultiDataTrigger.Conditions>
                                        <Condition Binding="{Binding IsLoading}" Value="False" />
                                        <Condition Binding="{Binding ValidationResults.Count}" Value="0" />
                                    </MultiDataTrigger.Conditions>
                                    <Setter Property="Visibility" Value="Visible" />
                                </MultiDataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ContentControl.Style>

                    <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                        <materialDesign:PackIcon
                            Width="64"
                            Height="64"
                            Kind="DatabaseSearch"
                            Opacity="0.4" />
                        <TextBlock
                            Margin="0,12,0,0"
                            FontSize="16"
                            Opacity="0.6"
                            Text="Chưa có dữ liệu" />
                        <TextBlock
                            Margin="0,4,0,0"
                            FontSize="14"
                            Opacity="0.5"
                            Text="Nhập số bệnh án/số tiếp nhận rồi nhấn Tra cứu" />
                    </StackPanel>
                </ContentControl>
            </Grid>
        </Grid>

        <!--  LOADING OVERLAY  -->
        <Border Background="#99FFFFFF" Visibility="{Binding IsLoading, Converter={StaticResource BoolToVis}}">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <ProgressBar
                    Width="60"
                    Height="60"
                    IsIndeterminate="True"
                    Style="{StaticResource MaterialDesignCircularProgressBar}" />
                <TextBlock
                    Margin="0,16,0,0"
                    FontSize="16"
                    FontWeight="Medium"
                    Text="Đang tải và kiểm tra dữ liệu..." />
            </StackPanel>
        </Border>

        <!--  CHi tiết lỗi  -->
        <Border
            Margin="10,-10,-10,10"
            Background="#80000000"
            Visibility="{Binding IsOverlayVisible, Converter={StaticResource BoolToVis}}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="0.05*" />
                    <RowDefinition Height="0.95*" />
                    <RowDefinition Height="0.1*" />
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="0.1*" />
                    <ColumnDefinition Width="0.9*" />
                    <ColumnDefinition Width="0.1*" />
                </Grid.ColumnDefinitions>

                <materialDesign:Card
                    Grid.Row="1"
                    Grid.Column="1"
                    Padding="16">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="*" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>


                        <!--  Tab Control với tối ưu hiệu suất  -->
                        <TabControl
                            Grid.Row="0"
                            RenderOptions.BitmapScalingMode="HighQuality"
                            RenderOptions.EdgeMode="Aliased"
                            SelectedIndex="0"
                            VirtualizingPanel.IsVirtualizing="True"
                            VirtualizingPanel.VirtualizationMode="Recycling">
                            <TabItem Style="{StaticResource ColoredTabItem}">
                                <TabItem.HeaderTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="XML1">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Foreground" Value="Black" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding DataContext.HasOverlayXml1Error, RelativeSource={RelativeSource AncestorType=UserControl}}" Value="True">
                                                            <Setter Property="Foreground" Value="Red" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </DataTemplate>
                                </TabItem.HeaderTemplate>
                                <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                                    <Grid Margin="16">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                        </Grid.RowDefinitions>

                                        <!--  Thông tin cá nhân  -->
                                        <materialDesign:Card
                                            Grid.Row="0"
                                            Margin="0,0,0,16"
                                            Padding="16">
                                            <StackPanel>
                                                <TextBlock
                                                    Margin="0,0,0,12"
                                                    FontSize="16"
                                                    FontWeight="Bold"
                                                    Foreground="#2196F3"
                                                    Text="THÔNG TIN CÁ NHÂN" />
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="*" />
                                                    </Grid.ColumnDefinitions>
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="Auto" />
                                                        <RowDefinition Height="Auto" />
                                                        <RowDefinition Height="Auto" />
                                                        <RowDefinition Height="Auto" />
                                                        <RowDefinition Height="Auto" />
                                                    </Grid.RowDefinitions>

                                                    <StackPanel
                                                        Grid.Row="0"
                                                        Grid.Column="0"
                                                        Margin="0,0,8,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Mã liên kết" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.Ma_Lk}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="0"
                                                        Grid.Column="1"
                                                        Margin="4,0,4,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Mã bệnh nhân" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.Ma_Bn}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="0"
                                                        Grid.Column="2"
                                                        Margin="8,0,0,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Số thứ tự" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.Stt}" />
                                                    </StackPanel>

                                                    <StackPanel
                                                        Grid.Row="1"
                                                        Grid.Column="0"
                                                        Margin="0,0,8,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Họ và tên" />
                                                        <TextBlock
                                                            FontSize="14"
                                                            FontWeight="SemiBold"
                                                            Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}"
                                                            Text="{Binding OverlayXml1Data.Ho_Ten}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="1"
                                                        Grid.Column="1"
                                                        Margin="4,0,4,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Số CCCD" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.So_Cccd}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="1"
                                                        Grid.Column="2"
                                                        Margin="8,0,0,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Ngày sinh" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.Ngay_Sinh}" />
                                                    </StackPanel>

                                                    <StackPanel
                                                        Grid.Row="2"
                                                        Grid.Column="0"
                                                        Margin="0,0,8,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Giới tính" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.Gioi_Tinh, Converter={StaticResource GenderConverter}}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="2"
                                                        Grid.Column="1"
                                                        Margin="4,0,4,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Quốc tịch" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.Ma_QuocTich}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="2"
                                                        Grid.Column="2"
                                                        Margin="8,0,0,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Dân tộc" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.Ma_DanToc}" />
                                                    </StackPanel>

                                                    <StackPanel
                                                        Grid.Row="3"
                                                        Grid.Column="0"
                                                        Margin="0,0,8,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Nghề nghiệp" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.Ma_Nghe_Nghiep}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="3"
                                                        Grid.Column="1"
                                                        Margin="4,0,4,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Địa chỉ" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.Dia_Chi}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="3"
                                                        Grid.Column="2"
                                                        Margin="8,0,0,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Điện thoại" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.Dien_Thoai}" />
                                                    </StackPanel>

                                                    <StackPanel
                                                        Grid.Row="4"
                                                        Grid.Column="0"
                                                        Margin="0,0,8,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Tỉnh cư trú" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.Matinh_Cu_Tru}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="4"
                                                        Grid.Column="1"
                                                        Margin="4,0,4,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Huyện cư trú" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.Mahuyen_Cu_Tru}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="4"
                                                        Grid.Column="2"
                                                        Margin="8,0,0,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Xã cư trú" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.Maxa_Cu_Tru}" />
                                                    </StackPanel>
                                                </Grid>
                                            </StackPanel>
                                        </materialDesign:Card>

                                        <!--  Thông tin BHYT  -->
                                        <materialDesign:Card
                                            Grid.Row="1"
                                            Margin="0,0,0,16"
                                            Padding="16">
                                            <StackPanel>
                                                <TextBlock
                                                    Margin="0,0,0,12"
                                                    FontSize="16"
                                                    FontWeight="Bold"
                                                    Foreground="#4CAF50"
                                                    Text="THÔNG TIN BHYT" />
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="*" />
                                                    </Grid.ColumnDefinitions>
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="Auto" />
                                                        <RowDefinition Height="Auto" />
                                                    </Grid.RowDefinitions>

                                                    <StackPanel
                                                        Grid.Row="0"
                                                        Grid.Column="0"
                                                        Margin="0,0,8,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Mã thẻ BHYT" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.Ma_The_Bhyt}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="0"
                                                        Grid.Column="1"
                                                        Margin="4,0,4,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Giá trị từ" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.Gt_The_Tu}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="0"
                                                        Grid.Column="2"
                                                        Margin="8,0,0,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Giá trị đến" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.Gt_The_Den}" />
                                                    </StackPanel>

                                                    <StackPanel
                                                        Grid.Row="1"
                                                        Grid.Column="0"
                                                        Margin="0,0,8,0">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Mã đăng ký KCB" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.Ma_Dkbd}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="1"
                                                        Grid.Column="1"
                                                        Margin="4,0,4,0">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Ngày miễn CCT" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.Ngay_Mien_Cct}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="1"
                                                        Grid.Column="2"
                                                        Margin="8,0,0,0">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Lý do viện vãng" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.Ly_Do_Vv}" />
                                                    </StackPanel>
                                                </Grid>
                                            </StackPanel>
                                        </materialDesign:Card>

                                        <!--  Thông tin điều trị  -->
                                        <materialDesign:Card
                                            Grid.Row="2"
                                            Margin="0,0,0,16"
                                            Padding="16">
                                            <StackPanel>
                                                <TextBlock
                                                    Margin="0,0,0,12"
                                                    FontSize="16"
                                                    FontWeight="Bold"
                                                    Foreground="#FF9800"
                                                    Text="THÔNG TIN ĐIỀU TRỊ" />
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="*" />
                                                    </Grid.ColumnDefinitions>
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="Auto" />
                                                        <RowDefinition Height="Auto" />
                                                        <RowDefinition Height="Auto" />
                                                        <RowDefinition Height="Auto" />
                                                        <RowDefinition Height="Auto" />
                                                    </Grid.RowDefinitions>

                                                    <StackPanel
                                                        Grid.Row="0"
                                                        Grid.Column="0"
                                                        Margin="0,0,8,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Chẩn đoán vào viện" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.Chan_DoAn_Vao}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="0"
                                                        Grid.Column="1"
                                                        Margin="4,0,4,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Chẩn đoán ra viện" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.Chan_DoAn_Rv}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="0"
                                                        Grid.Column="2"
                                                        Margin="8,0,0,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Mã bệnh chính" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.Ma_Benh_Chinh}" />
                                                    </StackPanel>

                                                    <StackPanel
                                                        Grid.Row="1"
                                                        Grid.Column="0"
                                                        Margin="0,0,8,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Ngày vào viện" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.Ngay_Vao}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="1"
                                                        Grid.Column="1"
                                                        Margin="4,0,4,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Ngày vào nội trú" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.Ngay_Vao_Noi_Tru}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="1"
                                                        Grid.Column="2"
                                                        Margin="8,0,0,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Ngày ra viện" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.Ngay_Ra}" />
                                                    </StackPanel>

                                                    <StackPanel
                                                        Grid.Row="2"
                                                        Grid.Column="0"
                                                        Margin="0,0,8,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Số ngày điều trị" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.So_Ngay_Dtri}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="2"
                                                        Grid.Column="1"
                                                        Margin="4,0,4,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Phương pháp điều trị" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.Pp_Dieu_Tri}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="2"
                                                        Grid.Column="2"
                                                        Margin="8,0,0,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Kết quả điều trị" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.Ket_Qua_Dtri}" />
                                                    </StackPanel>

                                                    <StackPanel
                                                        Grid.Row="3"
                                                        Grid.Column="0"
                                                        Margin="0,0,8,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Mã bệnh kèm theo" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.Ma_Benh_Kt}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="3"
                                                        Grid.Column="1"
                                                        Margin="4,0,4,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Mã bệnh YHCT" />
                                                        <TextBlock FontSize="14" Foreground="{Binding OverlayXml1Data.IsError, Converter={StaticResource ErrorToColorConverter}}" Text="{Binding OverlayXml1Data.Ma_Benh_Yhct}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="3"
                                                        Grid.Column="2"
                                                        Margin="8,0,0,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Mã phẫu thuật QT" />
                                                        <TextBlock FontSize="14" Text="{Binding OverlayXml1Data.Ma_Pttt_Qt}" />
                                                    </StackPanel>

                                                    <StackPanel
                                                        Grid.Row="4"
                                                        Grid.Column="0"
                                                        Margin="0,0,8,0">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Mã đối tượng KCB" />
                                                        <TextBlock FontSize="14" Text="{Binding OverlayXml1Data.Ma_DoiTuong_Kcb}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="4"
                                                        Grid.Column="1"
                                                        Margin="4,0,4,0">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Mã tai nạn" />
                                                        <TextBlock FontSize="14" Text="{Binding OverlayXml1Data.Ma_Tai_Nan}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="4"
                                                        Grid.Column="2"
                                                        Margin="8,0,0,0">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Mã loại ra viện" />
                                                        <TextBlock FontSize="14" Text="{Binding OverlayXml1Data.Ma_Loai_Rv}" />
                                                    </StackPanel>
                                                </Grid>
                                            </StackPanel>
                                        </materialDesign:Card>

                                        <!--  Thông tin thanh toán  -->
                                        <materialDesign:Card
                                            Grid.Row="3"
                                            Margin="0,0,0,16"
                                            Padding="16">
                                            <StackPanel>
                                                <TextBlock
                                                    Margin="0,0,0,12"
                                                    FontSize="16"
                                                    FontWeight="Bold"
                                                    Foreground="#9C27B0"
                                                    Text="THÔNG TIN THANH TOÁN" />
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="*" />
                                                    </Grid.ColumnDefinitions>
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="Auto" />
                                                        <RowDefinition Height="Auto" />
                                                        <RowDefinition Height="Auto" />
                                                    </Grid.RowDefinitions>

                                                    <StackPanel
                                                        Grid.Row="0"
                                                        Grid.Column="0"
                                                        Margin="0,0,8,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Tổng chi phí thuốc" />
                                                        <TextBlock
                                                            FontSize="14"
                                                            Foreground="#666"
                                                            Text="{Binding OverlayXml1Data.T_Thuoc, StringFormat='{}{0:N0} VNĐ'}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="0"
                                                        Grid.Column="1"
                                                        Margin="4,0,4,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Tổng chi phí VTYT" />
                                                        <TextBlock
                                                            FontSize="14"
                                                            Foreground="#666"
                                                            Text="{Binding OverlayXml1Data.T_Vtyt, StringFormat='{}{0:N0} VNĐ'}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="0"
                                                        Grid.Column="2"
                                                        Margin="8,0,0,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Tổng chi phí BV" />
                                                        <TextBlock
                                                            FontSize="14"
                                                            Foreground="#666"
                                                            Text="{Binding OverlayXml1Data.T_TongChi_Bv, StringFormat='{}{0:N0} VNĐ'}" />
                                                    </StackPanel>

                                                    <StackPanel
                                                        Grid.Row="1"
                                                        Grid.Column="0"
                                                        Margin="0,0,8,0">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="BHYT thanh toán" />
                                                        <TextBlock
                                                            FontSize="14"
                                                            Foreground="#666"
                                                            Text="{Binding OverlayXml1Data.T_TongChi_Bh, StringFormat='{}{0:N0} VNĐ'}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="1"
                                                        Grid.Column="1"
                                                        Margin="4,0,4,0">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Bệnh nhân trả" />
                                                        <TextBlock
                                                            FontSize="14"
                                                            Foreground="#666"
                                                            Text="{Binding OverlayXml1Data.T_Bntt, StringFormat='{}{0:N0} VNĐ'}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="1"
                                                        Grid.Column="2"
                                                        Margin="8,0,0,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Nguồn khác" />
                                                        <TextBlock FontSize="14" Text="{Binding OverlayXml1Data.T_NguonKhac, StringFormat='{}{0:N0} VNĐ'}" />
                                                    </StackPanel>

                                                    <StackPanel
                                                        Grid.Row="2"
                                                        Grid.Column="0"
                                                        Margin="0,0,8,0">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="BHYT trả trực tiếp" />
                                                        <TextBlock
                                                            FontSize="14"
                                                            Foreground="#666"
                                                            Text="{Binding OverlayXml1Data.T_Bhtt, StringFormat='{}{0:N0} VNĐ'}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="2"
                                                        Grid.Column="1"
                                                        Margin="4,0,4,0">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="BHYT trả GDV" />
                                                        <TextBlock
                                                            FontSize="14"
                                                            Foreground="#666"
                                                            Text="{Binding OverlayXml1Data.T_Bhtt_Gdv, StringFormat='{}{0:N0} VNĐ'}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="2"
                                                        Grid.Column="2"
                                                        Margin="8,0,0,0">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Ngày thanh toán" />
                                                        <TextBlock FontSize="14" Text="{Binding OverlayXml1Data.Ngay_Ttoan}" />
                                                    </StackPanel>
                                                </Grid>
                                            </StackPanel>
                                        </materialDesign:Card>

                                        <!--  Thông tin bổ sung  -->
                                        <materialDesign:Card Grid.Row="4" Padding="16">
                                            <StackPanel>
                                                <TextBlock
                                                    Margin="0,0,0,12"
                                                    FontSize="16"
                                                    FontWeight="Bold"
                                                    Foreground="#FF9800"
                                                    Text="THÔNG TIN BỔ SUNG" />
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="*" />
                                                    </Grid.ColumnDefinitions>
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="Auto" />
                                                        <RowDefinition Height="Auto" />
                                                        <RowDefinition Height="Auto" />
                                                        <RowDefinition Height="Auto" />
                                                        <RowDefinition Height="Auto" />
                                                    </Grid.RowDefinitions>

                                                    <StackPanel
                                                        Grid.Row="0"
                                                        Grid.Column="0"
                                                        Margin="0,0,8,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Mã khoa" />
                                                        <TextBlock FontSize="14" Text="{Binding OverlayXml1Data.Ma_Khoa}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="0"
                                                        Grid.Column="1"
                                                        Margin="4,0,4,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Mã CSKCB" />
                                                        <TextBlock FontSize="14" Text="{Binding OverlayXml1Data.Ma_Cskcb}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="0"
                                                        Grid.Column="2"
                                                        Margin="8,0,0,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Mã khu vực" />
                                                        <TextBlock FontSize="14" Text="{Binding OverlayXml1Data.Ma_KhuVuc}" />
                                                    </StackPanel>

                                                    <StackPanel
                                                        Grid.Row="1"
                                                        Grid.Column="0"
                                                        Margin="0,0,8,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Cân nặng" />
                                                        <TextBlock FontSize="14" Text="{Binding OverlayXml1Data.Can_Nang}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="1"
                                                        Grid.Column="1"
                                                        Margin="4,0,4,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Cân nặng con" />
                                                        <TextBlock FontSize="14" Text="{Binding OverlayXml1Data.Can_Nang_Con}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="1"
                                                        Grid.Column="2"
                                                        Margin="8,0,0,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Năm nam liên tục" />
                                                        <TextBlock FontSize="14" Text="{Binding OverlayXml1Data.Nam_Nam_Lien_Tuc}" />
                                                    </StackPanel>

                                                    <StackPanel
                                                        Grid.Row="2"
                                                        Grid.Column="0"
                                                        Margin="0,0,8,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Nhóm máu" />
                                                        <TextBlock FontSize="14" Text="{Binding OverlayXml1Data.Nhom_Mau}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="2"
                                                        Grid.Column="1"
                                                        Margin="4,0,4,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Ngày tái khám" />
                                                        <TextBlock FontSize="14" Text="{Binding OverlayXml1Data.Ngay_Tai_Kham}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="2"
                                                        Grid.Column="2"
                                                        Margin="8,0,0,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Mã HSBA" />
                                                        <TextBlock FontSize="14" Text="{Binding OverlayXml1Data.Ma_Hsba}" />
                                                    </StackPanel>

                                                    <StackPanel
                                                        Grid.Row="3"
                                                        Grid.Column="0"
                                                        Margin="0,0,8,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Mã TTDV" />
                                                        <TextBlock FontSize="14" Text="{Binding OverlayXml1Data.Ma_Ttdv}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="3"
                                                        Grid.Column="1"
                                                        Margin="4,0,4,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Dự phòng" />
                                                        <TextBlock FontSize="14" Text="{Binding OverlayXml1Data.Du_Phong}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="3"
                                                        Grid.Column="2"
                                                        Margin="8,0,0,8">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Năm quyết toán" />
                                                        <TextBlock FontSize="14" Text="{Binding OverlayXml1Data.Nam_Qt}" />
                                                    </StackPanel>

                                                    <StackPanel
                                                        Grid.Row="4"
                                                        Grid.Column="0"
                                                        Margin="0,0,8,0">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Tháng quyết toán" />
                                                        <TextBlock FontSize="14" Text="{Binding OverlayXml1Data.Thang_Qt}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="4"
                                                        Grid.Column="1"
                                                        Margin="4,0,4,0">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Mã loại KCB" />
                                                        <TextBlock FontSize="14" Text="{Binding OverlayXml1Data.Ma_Loai_Kcb}" />
                                                    </StackPanel>
                                                    <StackPanel
                                                        Grid.Row="4"
                                                        Grid.Column="2"
                                                        Margin="8,0,0,0">
                                                        <TextBlock
                                                            FontWeight="Bold"
                                                            Foreground="#666"
                                                            Text="Ghi chú" />
                                                        <TextBlock FontSize="14" Text="{Binding OverlayXml1Data.Ghi_Chu}" />
                                                    </StackPanel>
                                                </Grid>
                                            </StackPanel>
                                        </materialDesign:Card>
                                    </Grid>
                                </ScrollViewer>
                            </TabItem>

                            <TabItem Style="{StaticResource ColoredTabItem}">
                                <TabItem.HeaderTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="XML2">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Foreground" Value="Black" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding DataContext.HasOverlayXml2Error, RelativeSource={RelativeSource AncestorType=UserControl}}" Value="True">
                                                            <Setter Property="Foreground" Value="Red" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </DataTemplate>
                                </TabItem.HeaderTemplate>
                                <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                                    <Grid Margin="16">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="*" />
                                        </Grid.RowDefinitions>

                                        <!--  Header  -->
                                        <materialDesign:Card
                                            Grid.Row="0"
                                            Margin="0,0,0,16"
                                            Padding="16">
                                            <StackPanel>
                                                <TextBlock
                                                    Margin="0,0,0,8"
                                                    FontSize="18"
                                                    FontWeight="Bold"
                                                    Foreground="#1976D2"
                                                    Text="DANH SÁCH THUỐC SỬ DỤNG" />
                                                <TextBlock
                                                    FontSize="14"
                                                    Foreground="#666"
                                                    Text="Thông tin chi tiết về các loại thuốc bệnh nhân đã sử dụng trong quá trình điều trị" />
                                            </StackPanel>
                                        </materialDesign:Card>

                                        <!--  ItemsControl với Virtualization - Hiệu suất tối ưu  -->
                                        <materialDesign:Card Grid.Row="1" Padding="16">
                                            <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                                                <ItemsControl
                                                    ItemsSource="{Binding OverlayXml2Data}"
                                                    VirtualizingPanel.CacheLength="5,5"
                                                    VirtualizingPanel.CacheLengthUnit="Page"
                                                    VirtualizingPanel.IsVirtualizing="True"
                                                    VirtualizingPanel.VirtualizationMode="Recycling">
                                                    <!--  Header Template  -->
                                                    <ItemsControl.ItemsPanel>
                                                        <ItemsPanelTemplate>
                                                            <VirtualizingStackPanel Orientation="Vertical" />
                                                        </ItemsPanelTemplate>
                                                    </ItemsControl.ItemsPanel>

                                                    <!--  Header Row  -->
                                                    <ItemsControl.Template>
                                                        <ControlTemplate TargetType="ItemsControl">
                                                            <Grid>
                                                                <Grid.RowDefinitions>
                                                                    <RowDefinition Height="Auto" />
                                                                    <RowDefinition Height="*" />
                                                                </Grid.RowDefinitions>

                                                                <!--  Header  -->
                                                                <Border
                                                                    Grid.Row="0"
                                                                    Padding="8,6"
                                                                    Background="#F5F5F5"
                                                                    BorderBrush="#DDD"
                                                                    BorderThickness="0,0,0,1">
                                                                    <Grid>
                                                                        <Grid.ColumnDefinitions>
                                                                            <ColumnDefinition Width="100" />
                                                                            <ColumnDefinition Width="120" />
                                                                            <ColumnDefinition Width="120" />
                                                                            <ColumnDefinition Width="80" />
                                                                            <ColumnDefinition Width="200" />
                                                                            <ColumnDefinition Width="80" />
                                                                            <ColumnDefinition Width="100" />
                                                                            <ColumnDefinition Width="100" />
                                                                            <ColumnDefinition Width="120" />
                                                                            <ColumnDefinition Width="120" />
                                                                            <ColumnDefinition Width="120" />
                                                                            <ColumnDefinition Width="100" />
                                                                            <ColumnDefinition Width="80" />
                                                                            <ColumnDefinition Width="120" />
                                                                            <ColumnDefinition Width="80" />
                                                                            <ColumnDefinition Width="120" />
                                                                            <ColumnDefinition Width="120" />
                                                                            <ColumnDefinition Width="120" />
                                                                            <ColumnDefinition Width="120" />
                                                                            <ColumnDefinition Width="120" />
                                                                            <ColumnDefinition Width="120" />
                                                                            <ColumnDefinition Width="100" />
                                                                            <ColumnDefinition Width="100" />
                                                                            <ColumnDefinition Width="120" />
                                                                            <ColumnDefinition Width="120" />
                                                                            <ColumnDefinition Width="80" />
                                                                            <ColumnDefinition Width="100" />
                                                                            <ColumnDefinition Width="100" />
                                                                            <ColumnDefinition Width="100" />
                                                                            <ColumnDefinition Width="100" />
                                                                            <ColumnDefinition Width="100" />
                                                                            <ColumnDefinition Width="100" />
                                                                            <ColumnDefinition Width="100" />
                                                                            <ColumnDefinition Width="100" />
                                                                            <ColumnDefinition Width="100" />
                                                                            <ColumnDefinition Width="100" />
                                                                            <ColumnDefinition Width="100" />
                                                                            <ColumnDefinition Width="100" />
                                                                            <ColumnDefinition Width="100" />
                                                                        </Grid.ColumnDefinitions>

                                                                        <TextBlock
                                                                            Grid.Column="0"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="STT" />
                                                                        <TextBlock
                                                                            Grid.Column="1"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Mã thuốc" />
                                                                        <TextBlock
                                                                            Grid.Column="2"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Mã PP chế biến" />
                                                                        <TextBlock
                                                                            Grid.Column="3"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Mã CSKCB thuốc" />
                                                                        <TextBlock
                                                                            Grid.Column="4"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Mã nhóm" />
                                                                        <TextBlock
                                                                            Grid.Column="5"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Tên thuốc" />
                                                                        <TextBlock
                                                                            Grid.Column="6"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Đơn vị tính" />
                                                                        <TextBlock
                                                                            Grid.Column="7"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Hàm lượng" />
                                                                        <TextBlock
                                                                            Grid.Column="8"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Đường dùng" />
                                                                        <TextBlock
                                                                            Grid.Column="9"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Dạng bào chế" />
                                                                        <TextBlock
                                                                            Grid.Column="10"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Liều dùng" />
                                                                        <TextBlock
                                                                            Grid.Column="11"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Cách dùng" />
                                                                        <TextBlock
                                                                            Grid.Column="12"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Số đăng ký" />
                                                                        <TextBlock
                                                                            Grid.Column="13"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="TT thầu" />
                                                                        <TextBlock
                                                                            Grid.Column="14"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Phạm vi" />
                                                                        <TextBlock
                                                                            Grid.Column="15"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Tỷ lệ TT BH" />
                                                                        <TextBlock
                                                                            Grid.Column="16"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Số lượng" />
                                                                        <TextBlock
                                                                            Grid.Column="17"
                                                                            HorizontalAlignment="Right"
                                                                            FontWeight="Bold"
                                                                            Text="Đơn giá" />
                                                                        <TextBlock
                                                                            Grid.Column="18"
                                                                            HorizontalAlignment="Right"
                                                                            FontWeight="Bold"
                                                                            Text="Thành tiền BV" />
                                                                        <TextBlock
                                                                            Grid.Column="19"
                                                                            HorizontalAlignment="Right"
                                                                            FontWeight="Bold"
                                                                            Text="Thành tiền BH" />
                                                                        <TextBlock
                                                                            Grid.Column="20"
                                                                            HorizontalAlignment="Right"
                                                                            FontWeight="Bold"
                                                                            Text="T Nguồn khác NSNN" />
                                                                        <TextBlock
                                                                            Grid.Column="21"
                                                                            HorizontalAlignment="Right"
                                                                            FontWeight="Bold"
                                                                            Text="T Nguồn khác VTNN" />
                                                                        <TextBlock
                                                                            Grid.Column="22"
                                                                            HorizontalAlignment="Right"
                                                                            FontWeight="Bold"
                                                                            Text="T Nguồn khác VTTN" />
                                                                        <TextBlock
                                                                            Grid.Column="23"
                                                                            HorizontalAlignment="Right"
                                                                            FontWeight="Bold"
                                                                            Text="T Nguồn khác CL" />
                                                                        <TextBlock
                                                                            Grid.Column="24"
                                                                            HorizontalAlignment="Right"
                                                                            FontWeight="Bold"
                                                                            Text="T Nguồn khác" />
                                                                        <TextBlock
                                                                            Grid.Column="25"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Mức hưởng" />
                                                                        <TextBlock
                                                                            Grid.Column="26"
                                                                            HorizontalAlignment="Right"
                                                                            FontWeight="Bold"
                                                                            Text="T BNTT" />
                                                                        <TextBlock
                                                                            Grid.Column="27"
                                                                            HorizontalAlignment="Right"
                                                                            FontWeight="Bold"
                                                                            Text="T BNCCT" />
                                                                        <TextBlock
                                                                            Grid.Column="28"
                                                                            HorizontalAlignment="Right"
                                                                            FontWeight="Bold"
                                                                            Text="T BHTT" />
                                                                        <TextBlock
                                                                            Grid.Column="29"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Mã khoa" />
                                                                        <TextBlock
                                                                            Grid.Column="30"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Mã bác sĩ" />
                                                                        <TextBlock
                                                                            Grid.Column="31"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Mã dịch vụ" />
                                                                        <TextBlock
                                                                            Grid.Column="32"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Ngày YL" />
                                                                        <TextBlock
                                                                            Grid.Column="33"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Mã PTTT" />
                                                                        <TextBlock
                                                                            Grid.Column="34"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Nguồn CTRA" />
                                                                        <TextBlock
                                                                            Grid.Column="35"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Vết thương TP" />
                                                                        <TextBlock
                                                                            Grid.Column="36"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Dự phòng" />
                                                                        <TextBlock
                                                                            Grid.Column="37"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Ngày th YL" />
                                                                    </Grid>
                                                                </Border>

                                                                <!--  Items  -->
                                                                <ItemsPresenter Grid.Row="1" />
                                                            </Grid>
                                                        </ControlTemplate>
                                                    </ItemsControl.Template>

                                                    <!--  Item Template  -->
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate>
                                                            <Border
                                                                Background="Transparent"
                                                                BorderBrush="#E0E0E0"
                                                                BorderThickness="0,0,0,1">
                                                                <Border.Style>
                                                                    <Style TargetType="Border">
                                                                        <Setter Property="Background">
                                                                            <Setter.Value>
                                                                                <MultiBinding Converter="{StaticResource ErrorRowConverter}">
                                                                                    <Binding Path="Id" />
                                                                                    <Binding Path="DataContext.OverlayErrorIds" RelativeSource="{RelativeSource AncestorType=UserControl}" />
                                                                                </MultiBinding>
                                                                            </Setter.Value>
                                                                        </Setter>
                                                                        <Style.Triggers>
                                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                                <Setter Property="Background" Value="#F0F8FF" />
                                                                            </Trigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </Border.Style>

                                                                <Grid Margin="8,4">
                                                                    <Grid.ColumnDefinitions>
                                                                        <ColumnDefinition Width="100" />
                                                                        <ColumnDefinition Width="120" />
                                                                        <ColumnDefinition Width="120" />
                                                                        <ColumnDefinition Width="80" />
                                                                        <ColumnDefinition Width="200" />
                                                                        <ColumnDefinition Width="80" />
                                                                        <ColumnDefinition Width="100" />
                                                                        <ColumnDefinition Width="100" />
                                                                        <ColumnDefinition Width="120" />
                                                                        <ColumnDefinition Width="120" />
                                                                        <ColumnDefinition Width="120" />
                                                                        <ColumnDefinition Width="100" />
                                                                        <ColumnDefinition Width="80" />
                                                                        <ColumnDefinition Width="120" />
                                                                        <ColumnDefinition Width="80" />
                                                                        <ColumnDefinition Width="120" />
                                                                        <ColumnDefinition Width="120" />
                                                                        <ColumnDefinition Width="120" />
                                                                        <ColumnDefinition Width="120" />
                                                                        <ColumnDefinition Width="120" />
                                                                        <ColumnDefinition Width="120" />
                                                                        <ColumnDefinition Width="100" />
                                                                        <ColumnDefinition Width="100" />
                                                                        <ColumnDefinition Width="120" />
                                                                        <ColumnDefinition Width="120" />
                                                                        <ColumnDefinition Width="80" />
                                                                        <ColumnDefinition Width="100" />
                                                                        <ColumnDefinition Width="100" />
                                                                        <ColumnDefinition Width="100" />
                                                                        <ColumnDefinition Width="100" />
                                                                        <ColumnDefinition Width="100" />
                                                                        <ColumnDefinition Width="100" />
                                                                        <ColumnDefinition Width="100" />
                                                                        <ColumnDefinition Width="100" />
                                                                        <ColumnDefinition Width="100" />
                                                                        <ColumnDefinition Width="100" />
                                                                        <ColumnDefinition Width="100" />
                                                                        <ColumnDefinition Width="100" />
                                                                        <ColumnDefinition Width="100" />
                                                                        <ColumnDefinition Width="100" />
                                                                    </Grid.ColumnDefinitions>

                                                                    <TextBlock
                                                                        Grid.Column="0"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Text="{Binding Stt}">
                                                                        <TextBlock.Foreground>
                                                                            <MultiBinding Converter="{StaticResource ErrorTextConverter}">
                                                                                <Binding Path="Id" />
                                                                                <Binding Path="DataContext.OverlayErrorIds" RelativeSource="{RelativeSource AncestorType=UserControl}" />
                                                                            </MultiBinding>
                                                                        </TextBlock.Foreground>
                                                                    </TextBlock>
                                                                    <TextBlock
                                                                        Grid.Column="1"
                                                                        VerticalAlignment="Center"
                                                                        Text="{Binding Ma_Thuoc}"
                                                                        TextTrimming="CharacterEllipsis">
                                                                        <TextBlock.Foreground>
                                                                            <MultiBinding Converter="{StaticResource ErrorTextConverter}">
                                                                                <Binding Path="Id" />
                                                                                <Binding Path="DataContext.OverlayErrorIds" RelativeSource="{RelativeSource AncestorType=UserControl}" />
                                                                            </MultiBinding>
                                                                        </TextBlock.Foreground>
                                                                    </TextBlock>
                                                                    <TextBlock
                                                                        Grid.Column="2"
                                                                        VerticalAlignment="Center"
                                                                        Text="{Binding Ma_Pp_CheBien}"
                                                                        TextTrimming="CharacterEllipsis">
                                                                        <TextBlock.Foreground>
                                                                            <MultiBinding Converter="{StaticResource ErrorTextConverter}">
                                                                                <Binding Path="Id" />
                                                                                <Binding Path="DataContext.OverlayErrorIds" RelativeSource="{RelativeSource AncestorType=UserControl}" />
                                                                            </MultiBinding>
                                                                        </TextBlock.Foreground>
                                                                    </TextBlock>
                                                                    <TextBlock
                                                                        Grid.Column="3"
                                                                        VerticalAlignment="Center"
                                                                        Text="{Binding Ma_Cskcb_Thuoc}"
                                                                        TextTrimming="CharacterEllipsis">
                                                                        <TextBlock.Foreground>
                                                                            <MultiBinding Converter="{StaticResource ErrorTextConverter}">
                                                                                <Binding Path="Id" />
                                                                                <Binding Path="DataContext.OverlayErrorIds" RelativeSource="{RelativeSource AncestorType=UserControl}" />
                                                                            </MultiBinding>
                                                                        </TextBlock.Foreground>
                                                                    </TextBlock>
                                                                    <TextBlock
                                                                        Grid.Column="4"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Text="{Binding Ma_Nhom}">
                                                                        <TextBlock.Foreground>
                                                                            <MultiBinding Converter="{StaticResource ErrorTextConverter}">
                                                                                <Binding Path="Id" />
                                                                                <Binding Path="DataContext.OverlayErrorIds" RelativeSource="{RelativeSource AncestorType=UserControl}" />
                                                                            </MultiBinding>
                                                                        </TextBlock.Foreground>
                                                                    </TextBlock>
                                                                    <TextBlock
                                                                        Grid.Column="5"
                                                                        VerticalAlignment="Center"
                                                                        Text="{Binding Ten_Thuoc}"
                                                                        TextTrimming="CharacterEllipsis">
                                                                        <TextBlock.Foreground>
                                                                            <MultiBinding Converter="{StaticResource ErrorTextConverter}">
                                                                                <Binding Path="Id" />
                                                                                <Binding Path="DataContext.OverlayErrorIds" RelativeSource="{RelativeSource AncestorType=UserControl}" />
                                                                            </MultiBinding>
                                                                        </TextBlock.Foreground>
                                                                    </TextBlock>
                                                                    <TextBlock
                                                                        Grid.Column="6"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Text="{Binding Don_Vi_Tinh}">
                                                                        <TextBlock.Foreground>
                                                                            <MultiBinding Converter="{StaticResource ErrorTextConverter}">
                                                                                <Binding Path="Id" />
                                                                                <Binding Path="DataContext.OverlayErrorIds" RelativeSource="{RelativeSource AncestorType=UserControl}" />
                                                                            </MultiBinding>
                                                                        </TextBlock.Foreground>
                                                                    </TextBlock>
                                                                    <TextBlock
                                                                        Grid.Column="7"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Text="{Binding Ham_Luong}">
                                                                        <TextBlock.Foreground>
                                                                            <MultiBinding Converter="{StaticResource ErrorTextConverter}">
                                                                                <Binding Path="Id" />
                                                                                <Binding Path="DataContext.OverlayErrorIds" RelativeSource="{RelativeSource AncestorType=UserControl}" />
                                                                            </MultiBinding>
                                                                        </TextBlock.Foreground>
                                                                    </TextBlock>
                                                                    <TextBlock
                                                                        Grid.Column="8"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Text="{Binding Duong_Dung}">
                                                                        <TextBlock.Foreground>
                                                                            <MultiBinding Converter="{StaticResource ErrorTextConverter}">
                                                                                <Binding Path="Id" />
                                                                                <Binding Path="DataContext.OverlayErrorIds" RelativeSource="{RelativeSource AncestorType=UserControl}" />
                                                                            </MultiBinding>
                                                                        </TextBlock.Foreground>
                                                                    </TextBlock>
                                                                    <TextBlock
                                                                        Grid.Column="9"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Text="{Binding Dang_Bao_Che}">
                                                                        <TextBlock.Foreground>
                                                                            <MultiBinding Converter="{StaticResource ErrorTextConverter}">
                                                                                <Binding Path="Id" />
                                                                                <Binding Path="DataContext.OverlayErrorIds" RelativeSource="{RelativeSource AncestorType=UserControl}" />
                                                                            </MultiBinding>
                                                                        </TextBlock.Foreground>
                                                                    </TextBlock>
                                                                    <TextBlock
                                                                        Grid.Column="10"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Text="{Binding Lieu_Dung}">
                                                                        <TextBlock.Foreground>
                                                                            <MultiBinding Converter="{StaticResource ErrorTextConverter}">
                                                                                <Binding Path="Id" />
                                                                                <Binding Path="DataContext.OverlayErrorIds" RelativeSource="{RelativeSource AncestorType=UserControl}" />
                                                                            </MultiBinding>
                                                                        </TextBlock.Foreground>
                                                                    </TextBlock>
                                                                    <TextBlock
                                                                        Grid.Column="11"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Text="{Binding Cach_Dung}">
                                                                        <TextBlock.Foreground>
                                                                            <MultiBinding Converter="{StaticResource ErrorTextConverter}">
                                                                                <Binding Path="Id" />
                                                                                <Binding Path="DataContext.OverlayErrorIds" RelativeSource="{RelativeSource AncestorType=UserControl}" />
                                                                            </MultiBinding>
                                                                        </TextBlock.Foreground>
                                                                    </TextBlock>
                                                                    <TextBlock
                                                                        Grid.Column="12"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding So_Dang_Ky}" />
                                                                    <TextBlock
                                                                        Grid.Column="13"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Tt_Thau}" />
                                                                    <TextBlock
                                                                        Grid.Column="14"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Pham_Vi}" />
                                                                    <TextBlock
                                                                        Grid.Column="15"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Tyle_Tt_Bh, StringFormat='{}{0:P0}'}" />
                                                                    <TextBlock
                                                                        Grid.Column="16"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding So_Luong, StringFormat='{}{0:N0}'}" />
                                                                    <TextBlock
                                                                        Grid.Column="17"
                                                                        HorizontalAlignment="Right"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Don_Gia, StringFormat='{}{0:N0} VNĐ'}" />
                                                                    <TextBlock
                                                                        Grid.Column="18"
                                                                        HorizontalAlignment="Right"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Thanh_Tien_Bv, StringFormat='{}{0:N0} VNĐ'}" />
                                                                    <TextBlock
                                                                        Grid.Column="19"
                                                                        HorizontalAlignment="Right"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Thanh_Tien_Bh, StringFormat='{}{0:N0} VNĐ'}" />
                                                                    <TextBlock
                                                                        Grid.Column="20"
                                                                        HorizontalAlignment="Right"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding T_NguonKhac_Nsnn, StringFormat='{}{0:N0} VNĐ'}" />
                                                                    <TextBlock
                                                                        Grid.Column="21"
                                                                        HorizontalAlignment="Right"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding T_NguonKhac_Vtnn, StringFormat='{}{0:N0} VNĐ'}" />
                                                                    <TextBlock
                                                                        Grid.Column="22"
                                                                        HorizontalAlignment="Right"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding T_NguonKhac_Vttn, StringFormat='{}{0:N0} VNĐ'}" />
                                                                    <TextBlock
                                                                        Grid.Column="23"
                                                                        HorizontalAlignment="Right"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding T_NguonKhac_Cl, StringFormat='{}{0:N0} VNĐ'}" />
                                                                    <TextBlock
                                                                        Grid.Column="24"
                                                                        HorizontalAlignment="Right"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding T_NguonKhac, StringFormat='{}{0:N0} VNĐ'}" />
                                                                    <TextBlock
                                                                        Grid.Column="25"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Muc_Huong, StringFormat='{}{0:P0}'}" />
                                                                    <TextBlock
                                                                        Grid.Column="26"
                                                                        HorizontalAlignment="Right"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding T_Bntt, StringFormat='{}{0:N0} VNĐ'}" />
                                                                    <TextBlock
                                                                        Grid.Column="27"
                                                                        HorizontalAlignment="Right"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding T_Bncct, StringFormat='{}{0:N0} VNĐ'}" />
                                                                    <TextBlock
                                                                        Grid.Column="28"
                                                                        HorizontalAlignment="Right"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding T_Bhtt, StringFormat='{}{0:N0} VNĐ'}" />
                                                                    <TextBlock
                                                                        Grid.Column="29"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Ma_Khoa}" />
                                                                    <TextBlock
                                                                        Grid.Column="30"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Ma_Bac_Si}" />
                                                                    <TextBlock
                                                                        Grid.Column="31"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Ma_Dich_Vu}" />
                                                                    <TextBlock
                                                                        Grid.Column="32"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Ngay_Yl}" />
                                                                    <TextBlock
                                                                        Grid.Column="33"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Ma_Pttt}" />
                                                                    <TextBlock
                                                                        Grid.Column="34"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Nguon_Ctra}" />
                                                                    <TextBlock
                                                                        Grid.Column="35"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Vet_Thuong_Tp}" />
                                                                    <TextBlock
                                                                        Grid.Column="36"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Du_Phong}" />
                                                                    <TextBlock
                                                                        Grid.Column="37"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Ngay_Th_Yl}" />
                                                                </Grid>
                                                            </Border>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                            </ScrollViewer>
                                        </materialDesign:Card>
                                    </Grid>
                                </ScrollViewer>
                            </TabItem>

                            <TabItem Style="{StaticResource ColoredTabItem}">
                                <TabItem.HeaderTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="XML3">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Foreground" Value="Black" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding DataContext.HasOverlayXml3Error, RelativeSource={RelativeSource AncestorType=UserControl}}" Value="True">
                                                            <Setter Property="Foreground" Value="Red" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </DataTemplate>
                                </TabItem.HeaderTemplate>
                                <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                                    <Grid Margin="16">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="*" />
                                        </Grid.RowDefinitions>

                                        <!--  Header  -->
                                        <materialDesign:Card
                                            Grid.Row="0"
                                            Margin="0,0,0,16"
                                            Padding="16">
                                            <StackPanel>
                                                <TextBlock
                                                    Margin="0,0,0,8"
                                                    FontSize="18"
                                                    FontWeight="Bold"
                                                    Foreground="#1976D2"
                                                    Text="DANH SÁCH VẬT TƯ Y TẾ" />
                                                <TextBlock
                                                    FontSize="14"
                                                    Foreground="#666"
                                                    Text="Thông tin chi tiết về các vật tư y tế, thiết bị và dịch vụ kỹ thuật đã sử dụng" />
                                            </StackPanel>
                                        </materialDesign:Card>

                                        <!--  ItemsControl với Virtualization - Hiệu suất tối ưu  -->
                                        <materialDesign:Card Grid.Row="1" Padding="16">
                                            <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                                                <ItemsControl
                                                    ItemsSource="{Binding OverlayXml3Data}"
                                                    VirtualizingPanel.CacheLength="5,5"
                                                    VirtualizingPanel.CacheLengthUnit="Page"
                                                    VirtualizingPanel.IsVirtualizing="True"
                                                    VirtualizingPanel.VirtualizationMode="Recycling">
                                                    <ItemsControl.ItemsPanel>
                                                        <ItemsPanelTemplate>
                                                            <VirtualizingStackPanel Orientation="Vertical" />
                                                        </ItemsPanelTemplate>
                                                    </ItemsControl.ItemsPanel>

                                                    <!--  Header Row  -->
                                                    <ItemsControl.Template>
                                                        <ControlTemplate TargetType="ItemsControl">
                                                            <Grid>
                                                                <Grid.RowDefinitions>
                                                                    <RowDefinition Height="Auto" />
                                                                    <RowDefinition Height="*" />
                                                                </Grid.RowDefinitions>

                                                                <!--  Header  -->
                                                                <Border
                                                                    Grid.Row="0"
                                                                    Padding="8,6"
                                                                    Background="#F5F5F5"
                                                                    BorderBrush="#DDD"
                                                                    BorderThickness="0,0,0,1">
                                                                    <Grid>
                                                                        <Grid.ColumnDefinitions>
                                                                            <ColumnDefinition Width="50" />
                                                                            <ColumnDefinition Width="100" />
                                                                            <ColumnDefinition Width="100" />
                                                                            <ColumnDefinition Width="200" />
                                                                            <ColumnDefinition Width="200" />
                                                                            <ColumnDefinition Width="80" />
                                                                            <ColumnDefinition Width="80" />
                                                                            <ColumnDefinition Width="120" />
                                                                            <ColumnDefinition Width="120" />
                                                                            <ColumnDefinition Width="120" />
                                                                            <ColumnDefinition Width="120" />
                                                                            <ColumnDefinition Width="100" />
                                                                            <ColumnDefinition Width="100" />
                                                                            <ColumnDefinition Width="100" />
                                                                            <ColumnDefinition Width="120" />
                                                                            <ColumnDefinition Width="120" />
                                                                            <ColumnDefinition Width="80" />
                                                                            <ColumnDefinition Width="80" />
                                                                            <ColumnDefinition Width="100" />
                                                                            <ColumnDefinition Width="120" />
                                                                            <ColumnDefinition Width="100" />
                                                                            <ColumnDefinition Width="120" />
                                                                            <ColumnDefinition Width="120" />
                                                                        </Grid.ColumnDefinitions>

                                                                        <TextBlock
                                                                            Grid.Column="0"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="STT" />
                                                                        <TextBlock
                                                                            Grid.Column="1"
                                                                            FontWeight="Bold"
                                                                            Text="Mã dịch vụ" />
                                                                        <TextBlock
                                                                            Grid.Column="2"
                                                                            FontWeight="Bold"
                                                                            Text="Mã vật tư" />
                                                                        <TextBlock
                                                                            Grid.Column="3"
                                                                            FontWeight="Bold"
                                                                            Text="Tên vật tư" />
                                                                        <TextBlock
                                                                            Grid.Column="4"
                                                                            FontWeight="Bold"
                                                                            Text="Tên dịch vụ" />
                                                                        <TextBlock
                                                                            Grid.Column="5"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Đơn vị tính" />
                                                                        <TextBlock
                                                                            Grid.Column="6"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Số lượng" />
                                                                        <TextBlock
                                                                            Grid.Column="7"
                                                                            HorizontalAlignment="Right"
                                                                            FontWeight="Bold"
                                                                            Text="Đơn giá BV" />
                                                                        <TextBlock
                                                                            Grid.Column="8"
                                                                            HorizontalAlignment="Right"
                                                                            FontWeight="Bold"
                                                                            Text="Đơn giá BH" />
                                                                        <TextBlock
                                                                            Grid.Column="9"
                                                                            HorizontalAlignment="Right"
                                                                            FontWeight="Bold"
                                                                            Text="Thành tiền BV" />
                                                                        <TextBlock
                                                                            Grid.Column="10"
                                                                            HorizontalAlignment="Right"
                                                                            FontWeight="Bold"
                                                                            Text="Thành tiền BH" />
                                                                        <TextBlock
                                                                            Grid.Column="11"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Tỷ lệ TT DV" />
                                                                        <TextBlock
                                                                            Grid.Column="12"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Tỷ lệ TT BH" />
                                                                        <TextBlock
                                                                            Grid.Column="13"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Mức hưởng" />
                                                                        <TextBlock
                                                                            Grid.Column="14"
                                                                            HorizontalAlignment="Right"
                                                                            FontWeight="Bold"
                                                                            Text="Bệnh nhân trả" />
                                                                        <TextBlock
                                                                            Grid.Column="15"
                                                                            HorizontalAlignment="Right"
                                                                            FontWeight="Bold"
                                                                            Text="BHYT trả" />
                                                                        <TextBlock
                                                                            Grid.Column="16"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Mã khoa" />
                                                                        <TextBlock
                                                                            Grid.Column="17"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Mã giường" />
                                                                        <TextBlock
                                                                            Grid.Column="18"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Mã bác sĩ" />
                                                                        <TextBlock
                                                                            Grid.Column="19"
                                                                            FontWeight="Bold"
                                                                            Text="Người thực hiện" />
                                                                        <TextBlock
                                                                            Grid.Column="20"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Ngày YL" />
                                                                        <TextBlock
                                                                            Grid.Column="21"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Ngày thực hiện" />
                                                                        <TextBlock
                                                                            Grid.Column="22"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Ngày kết quả" />
                                                                    </Grid>
                                                                </Border>

                                                                <!--  Items  -->
                                                                <ItemsPresenter Grid.Row="1" />
                                                            </Grid>
                                                        </ControlTemplate>
                                                    </ItemsControl.Template>

                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate>
                                                            <Border
                                                                Margin="8,4"
                                                                Background="Transparent"
                                                                BorderBrush="#E0E0E0"
                                                                BorderThickness="0,0,0,1">
                                                                <Border.Style>
                                                                    <Style TargetType="Border">
                                                                        <Setter Property="Background">
                                                                            <Setter.Value>
                                                                                <MultiBinding Converter="{StaticResource ErrorRowConverter}">
                                                                                    <Binding Path="Id" />
                                                                                    <Binding Path="DataContext.OverlayErrorIds" RelativeSource="{RelativeSource AncestorType=UserControl}" />
                                                                                </MultiBinding>
                                                                            </Setter.Value>
                                                                        </Setter>
                                                                        <Style.Triggers>
                                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                                <Setter Property="Background" Value="#F0F8FF" />
                                                                            </Trigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </Border.Style>

                                                                <Grid>
                                                                    <Grid.ColumnDefinitions>
                                                                        <ColumnDefinition Width="50" />
                                                                        <ColumnDefinition Width="100" />
                                                                        <ColumnDefinition Width="100" />
                                                                        <ColumnDefinition Width="200" />
                                                                        <ColumnDefinition Width="200" />
                                                                        <ColumnDefinition Width="80" />
                                                                        <ColumnDefinition Width="80" />
                                                                        <ColumnDefinition Width="120" />
                                                                        <ColumnDefinition Width="120" />
                                                                        <ColumnDefinition Width="120" />
                                                                        <ColumnDefinition Width="120" />
                                                                        <ColumnDefinition Width="100" />
                                                                        <ColumnDefinition Width="100" />
                                                                        <ColumnDefinition Width="100" />
                                                                        <ColumnDefinition Width="120" />
                                                                        <ColumnDefinition Width="120" />
                                                                        <ColumnDefinition Width="80" />
                                                                        <ColumnDefinition Width="80" />
                                                                        <ColumnDefinition Width="100" />
                                                                        <ColumnDefinition Width="120" />
                                                                        <ColumnDefinition Width="100" />
                                                                        <ColumnDefinition Width="120" />
                                                                        <ColumnDefinition Width="120" />
                                                                    </Grid.ColumnDefinitions>

                                                                    <TextBlock
                                                                        Grid.Column="0"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Stt}" />
                                                                    <TextBlock
                                                                        Grid.Column="1"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Ma_Dich_Vu}"
                                                                        TextTrimming="CharacterEllipsis" />
                                                                    <TextBlock
                                                                        Grid.Column="2"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Ma_Vat_Tu}"
                                                                        TextTrimming="CharacterEllipsis" />
                                                                    <TextBlock
                                                                        Grid.Column="3"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Ten_Vat_Tu}"
                                                                        TextTrimming="CharacterEllipsis" />
                                                                    <TextBlock
                                                                        Grid.Column="4"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Ten_Dich_Vu}"
                                                                        TextTrimming="CharacterEllipsis" />
                                                                    <TextBlock
                                                                        Grid.Column="5"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Don_Vi_Tinh}" />
                                                                    <TextBlock
                                                                        Grid.Column="6"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding So_Luong, StringFormat='{}{0:N0}'}" />
                                                                    <TextBlock
                                                                        Grid.Column="7"
                                                                        HorizontalAlignment="Right"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Don_Gia_Bv, StringFormat='{}{0:N0} VNĐ'}" />
                                                                    <TextBlock
                                                                        Grid.Column="8"
                                                                        HorizontalAlignment="Right"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Don_Gia_Bh, StringFormat='{}{0:N0} VNĐ'}" />
                                                                    <TextBlock
                                                                        Grid.Column="9"
                                                                        HorizontalAlignment="Right"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Thanh_Tien_Bv, StringFormat='{}{0:N0} VNĐ'}" />
                                                                    <TextBlock
                                                                        Grid.Column="10"
                                                                        HorizontalAlignment="Right"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Thanh_Tien_Bh, StringFormat='{}{0:N0} VNĐ'}" />
                                                                    <TextBlock
                                                                        Grid.Column="11"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Tyle_Tt_Dv, StringFormat='{}{0:P0}'}" />
                                                                    <TextBlock
                                                                        Grid.Column="12"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Tyle_Tt_Bh, StringFormat='{}{0:P0}'}" />
                                                                    <TextBlock
                                                                        Grid.Column="13"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Muc_Huong, StringFormat='{}{0:P0}'}" />
                                                                    <TextBlock
                                                                        Grid.Column="14"
                                                                        HorizontalAlignment="Right"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding T_Bntt, StringFormat='{}{0:N0} VNĐ'}" />
                                                                    <TextBlock
                                                                        Grid.Column="15"
                                                                        HorizontalAlignment="Right"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding T_Bhtt, StringFormat='{}{0:N0} VNĐ'}" />
                                                                    <TextBlock
                                                                        Grid.Column="16"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Ma_Khoa}" />
                                                                    <TextBlock
                                                                        Grid.Column="17"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Ma_Giuong}" />
                                                                    <TextBlock
                                                                        Grid.Column="18"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Ma_Bac_Si}" />
                                                                    <TextBlock
                                                                        Grid.Column="19"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Nguoi_Thuc_Hien}"
                                                                        TextTrimming="CharacterEllipsis" />
                                                                    <TextBlock
                                                                        Grid.Column="20"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Ngay_Yl}" />
                                                                    <TextBlock
                                                                        Grid.Column="21"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Ngay_Th_Yl}" />
                                                                    <TextBlock
                                                                        Grid.Column="22"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Ngay_Kq}" />
                                                                </Grid>
                                                            </Border>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                            </ScrollViewer>
                                        </materialDesign:Card>
                                    </Grid>
                                </ScrollViewer>
                            </TabItem>

                            <TabItem Style="{StaticResource ColoredTabItem}">
                                <TabItem.HeaderTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="XML4">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Foreground" Value="Black" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding DataContext.HasOverlayXml4Error, RelativeSource={RelativeSource AncestorType=UserControl}}" Value="True">
                                                            <Setter Property="Foreground" Value="Red" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </DataTemplate>
                                </TabItem.HeaderTemplate>
                                <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                                    <Grid Margin="16">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="*" />
                                        </Grid.RowDefinitions>

                                        <!--  Header  -->
                                        <materialDesign:Card
                                            Grid.Row="0"
                                            Margin="0,0,0,16"
                                            Padding="16">
                                            <StackPanel>
                                                <TextBlock
                                                    Margin="0,0,0,8"
                                                    FontSize="18"
                                                    FontWeight="Bold"
                                                    Foreground="#1976D2"
                                                    Text="DANH SÁCH XÉT NGHIỆM" />
                                                <TextBlock
                                                    FontSize="14"
                                                    Foreground="#666"
                                                    Text="Thông tin chi tiết về các xét nghiệm, cận lâm sàng đã thực hiện" />
                                            </StackPanel>
                                        </materialDesign:Card>

                                        <!--  ItemsControl với Virtualization - Hiệu suất tối ưu  -->
                                        <materialDesign:Card Grid.Row="1" Padding="16">
                                            <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                                                <ItemsControl
                                                    ItemsSource="{Binding OverlayXml4Data}"
                                                    VirtualizingPanel.CacheLength="5,5"
                                                    VirtualizingPanel.CacheLengthUnit="Page"
                                                    VirtualizingPanel.IsVirtualizing="True"
                                                    VirtualizingPanel.VirtualizationMode="Recycling">
                                                    <ItemsControl.ItemsPanel>
                                                        <ItemsPanelTemplate>
                                                            <VirtualizingStackPanel Orientation="Vertical" />
                                                        </ItemsPanelTemplate>
                                                    </ItemsControl.ItemsPanel>

                                                    <!--  Header Row  -->
                                                    <ItemsControl.Template>
                                                        <ControlTemplate TargetType="ItemsControl">
                                                            <Grid>
                                                                <Grid.RowDefinitions>
                                                                    <RowDefinition Height="Auto" />
                                                                    <RowDefinition Height="*" />
                                                                </Grid.RowDefinitions>

                                                                <!--  Header  -->
                                                                <Border
                                                                    Grid.Row="0"
                                                                    Padding="8,6"
                                                                    Background="#F5F5F5"
                                                                    BorderBrush="#DDD"
                                                                    BorderThickness="0,0,0,1">
                                                                    <Grid>
                                                                        <Grid.ColumnDefinitions>
                                                                            <ColumnDefinition Width="50" />
                                                                            <ColumnDefinition Width="100" />
                                                                            <ColumnDefinition Width="100" />
                                                                            <ColumnDefinition Width="200" />
                                                                            <ColumnDefinition Width="100" />
                                                                            <ColumnDefinition Width="100" />
                                                                            <ColumnDefinition Width="200" />
                                                                            <ColumnDefinition Width="150" />
                                                                            <ColumnDefinition Width="120" />
                                                                            <ColumnDefinition Width="120" />
                                                                            <ColumnDefinition Width="100" />
                                                                        </Grid.ColumnDefinitions>

                                                                        <TextBlock
                                                                            Grid.Column="0"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="STT" />
                                                                        <TextBlock
                                                                            Grid.Column="1"
                                                                            FontWeight="Bold"
                                                                            Text="Mã dịch vụ" />
                                                                        <TextBlock
                                                                            Grid.Column="2"
                                                                            FontWeight="Bold"
                                                                            Text="Mã chỉ số" />
                                                                        <TextBlock
                                                                            Grid.Column="3"
                                                                            FontWeight="Bold"
                                                                            Text="Tên chỉ số" />
                                                                        <TextBlock
                                                                            Grid.Column="4"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Giá trị" />
                                                                        <TextBlock
                                                                            Grid.Column="5"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Đơn vị đo" />
                                                                        <TextBlock
                                                                            Grid.Column="6"
                                                                            FontWeight="Bold"
                                                                            Text="Mô tả" />
                                                                        <TextBlock
                                                                            Grid.Column="7"
                                                                            FontWeight="Bold"
                                                                            Text="Kết luận" />
                                                                        <TextBlock
                                                                            Grid.Column="8"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Ngày kết quả" />
                                                                        <TextBlock
                                                                            Grid.Column="9"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Mã BS đọc KQ" />
                                                                        <TextBlock
                                                                            Grid.Column="10"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Dự phòng" />
                                                                    </Grid>
                                                                </Border>

                                                                <!--  Items  -->
                                                                <ItemsPresenter Grid.Row="1" />
                                                            </Grid>
                                                        </ControlTemplate>
                                                    </ItemsControl.Template>

                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate>
                                                            <Border
                                                                Margin="8,4"
                                                                Background="Transparent"
                                                                BorderBrush="#E0E0E0"
                                                                BorderThickness="0,0,0,1">
                                                                <Border.Style>
                                                                    <Style TargetType="Border">
                                                                        <Setter Property="Background">
                                                                            <Setter.Value>
                                                                                <MultiBinding Converter="{StaticResource ErrorRowConverter}">
                                                                                    <Binding Path="Id" />
                                                                                    <Binding Path="DataContext.OverlayErrorIds" RelativeSource="{RelativeSource AncestorType=UserControl}" />
                                                                                </MultiBinding>
                                                                            </Setter.Value>
                                                                        </Setter>
                                                                        <Style.Triggers>
                                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                                <Setter Property="Background" Value="#F0F8FF" />
                                                                            </Trigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </Border.Style>

                                                                <Grid>
                                                                    <Grid.ColumnDefinitions>
                                                                        <ColumnDefinition Width="50" />
                                                                        <ColumnDefinition Width="100" />
                                                                        <ColumnDefinition Width="100" />
                                                                        <ColumnDefinition Width="200" />
                                                                        <ColumnDefinition Width="100" />
                                                                        <ColumnDefinition Width="100" />
                                                                        <ColumnDefinition Width="200" />
                                                                        <ColumnDefinition Width="150" />
                                                                        <ColumnDefinition Width="120" />
                                                                        <ColumnDefinition Width="120" />
                                                                        <ColumnDefinition Width="100" />
                                                                    </Grid.ColumnDefinitions>

                                                                    <TextBlock
                                                                        Grid.Column="0"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Text="{Binding Stt}" />
                                                                    <TextBlock
                                                                        Grid.Column="1"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Ma_Dich_Vu}"
                                                                        TextTrimming="CharacterEllipsis" />
                                                                    <TextBlock
                                                                        Grid.Column="2"
                                                                        VerticalAlignment="Center"
                                                                        Text="{Binding Ma_Chi_So}"
                                                                        TextTrimming="CharacterEllipsis" />
                                                                    <TextBlock
                                                                        Grid.Column="3"
                                                                        VerticalAlignment="Center"
                                                                        Text="{Binding Ten_Chi_So}"
                                                                        TextTrimming="CharacterEllipsis" />
                                                                    <TextBlock
                                                                        Grid.Column="4"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Text="{Binding Gia_Tri}" />
                                                                    <TextBlock
                                                                        Grid.Column="5"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Text="{Binding Don_Vi_Do}" />
                                                                    <TextBlock
                                                                        Grid.Column="6"
                                                                        VerticalAlignment="Center"
                                                                        Text="{Binding Mo_Ta}"
                                                                        TextTrimming="CharacterEllipsis" />
                                                                    <TextBlock
                                                                        Grid.Column="7"
                                                                        VerticalAlignment="Center"
                                                                        Text="{Binding Ket_Luan}"
                                                                        TextTrimming="CharacterEllipsis" />
                                                                    <TextBlock
                                                                        Grid.Column="8"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Ngay_Kq}" />
                                                                    <TextBlock
                                                                        Grid.Column="9"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Text="{Binding Ma_Bs_Doc_Kq}" />
                                                                    <TextBlock
                                                                        Grid.Column="10"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Text="{Binding Du_Phong}" />
                                                                </Grid>
                                                            </Border>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                            </ScrollViewer>
                                        </materialDesign:Card>
                                    </Grid>
                                </ScrollViewer>
                            </TabItem>

                            <TabItem Style="{StaticResource ColoredTabItem}">
                                <TabItem.HeaderTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="XML5">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Foreground" Value="Black" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding DataContext.HasOverlayXml5Error, RelativeSource={RelativeSource AncestorType=UserControl}}" Value="True">
                                                            <Setter Property="Foreground" Value="Red" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </DataTemplate>
                                </TabItem.HeaderTemplate>
                                <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                                    <Grid Margin="16">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="*" />
                                        </Grid.RowDefinitions>

                                        <!--  Header  -->
                                        <materialDesign:Card
                                            Grid.Row="0"
                                            Margin="0,0,0,16"
                                            Padding="16">
                                            <StackPanel>
                                                <TextBlock
                                                    Margin="0,0,0,8"
                                                    FontSize="18"
                                                    FontWeight="Bold"
                                                    Foreground="#1976D2"
                                                    Text="DANH SÁCH DIỄN BIẾN LÂM SÀNG" />
                                                <TextBlock
                                                    FontSize="14"
                                                    Foreground="#666"
                                                    Text="Thông tin chi tiết về diễn biến lâm sàng, hội chẩn và các ghi chú trong quá trình điều trị" />
                                            </StackPanel>
                                        </materialDesign:Card>

                                        <!--  ItemsControl với Virtualization - Hiệu suất tối ưu  -->
                                        <materialDesign:Card Grid.Row="1" Padding="16">
                                            <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                                                <ItemsControl
                                                    ItemsSource="{Binding OverlayXml5Data}"
                                                    VirtualizingPanel.CacheLength="5,5"
                                                    VirtualizingPanel.CacheLengthUnit="Page"
                                                    VirtualizingPanel.IsVirtualizing="True"
                                                    VirtualizingPanel.VirtualizationMode="Recycling">
                                                    <ItemsControl.ItemsPanel>
                                                        <ItemsPanelTemplate>
                                                            <VirtualizingStackPanel Orientation="Vertical" />
                                                        </ItemsPanelTemplate>
                                                    </ItemsControl.ItemsPanel>

                                                    <!--  Header Row  -->
                                                    <ItemsControl.Template>
                                                        <ControlTemplate TargetType="ItemsControl">
                                                            <Grid>
                                                                <Grid.RowDefinitions>
                                                                    <RowDefinition Height="Auto" />
                                                                    <RowDefinition Height="*" />
                                                                </Grid.RowDefinitions>

                                                                <!--  Header  -->
                                                                <Border
                                                                    Grid.Row="0"
                                                                    Padding="8,6"
                                                                    Background="#F5F5F5"
                                                                    BorderBrush="#DDD"
                                                                    BorderThickness="0,0,0,1">
                                                                    <Grid>
                                                                        <Grid.ColumnDefinitions>
                                                                            <ColumnDefinition Width="50" />
                                                                            <ColumnDefinition Width="300" />
                                                                            <ColumnDefinition Width="150" />
                                                                            <ColumnDefinition Width="300" />
                                                                            <ColumnDefinition Width="150" />
                                                                            <ColumnDefinition Width="150" />
                                                                            <ColumnDefinition Width="150" />
                                                                            <ColumnDefinition Width="200" />
                                                                        </Grid.ColumnDefinitions>

                                                                        <TextBlock
                                                                            Grid.Column="0"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="STT" />
                                                                        <TextBlock
                                                                            Grid.Column="1"
                                                                            FontWeight="Bold"
                                                                            Text="Diễn biến lâm sàng" />
                                                                        <TextBlock
                                                                            Grid.Column="2"
                                                                            FontWeight="Bold"
                                                                            Text="Giai đoạn bệnh" />
                                                                        <TextBlock
                                                                            Grid.Column="3"
                                                                            FontWeight="Bold"
                                                                            Text="Hội chẩn" />
                                                                        <TextBlock
                                                                            Grid.Column="4"
                                                                            FontWeight="Bold"
                                                                            Text="Phẫu thuật" />
                                                                        <TextBlock
                                                                            Grid.Column="5"
                                                                            HorizontalAlignment="Center"
                                                                            FontWeight="Bold"
                                                                            Text="Thời điểm diễn biến" />
                                                                        <TextBlock
                                                                            Grid.Column="6"
                                                                            FontWeight="Bold"
                                                                            Text="Người thực hiện" />
                                                                        <TextBlock
                                                                            Grid.Column="7"
                                                                            FontWeight="Bold"
                                                                            Text="Dự phòng" />
                                                                    </Grid>
                                                                </Border>

                                                                <!--  Items  -->
                                                                <ItemsPresenter Grid.Row="1" />
                                                            </Grid>
                                                        </ControlTemplate>
                                                    </ItemsControl.Template>

                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate>
                                                            <Border
                                                                Margin="8,4"
                                                                Background="Transparent"
                                                                BorderBrush="#E0E0E0"
                                                                BorderThickness="0,0,0,1">
                                                                <Border.Style>
                                                                    <Style TargetType="Border">
                                                                        <Setter Property="Background">
                                                                            <Setter.Value>
                                                                                <MultiBinding Converter="{StaticResource ErrorRowConverter}">
                                                                                    <Binding Path="Id" />
                                                                                    <Binding Path="DataContext.OverlayErrorIds" RelativeSource="{RelativeSource AncestorType=UserControl}" />
                                                                                </MultiBinding>
                                                                            </Setter.Value>
                                                                        </Setter>
                                                                        <Style.Triggers>
                                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                                <Setter Property="Background" Value="#F0F8FF" />
                                                                            </Trigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </Border.Style>

                                                                <Grid>
                                                                    <Grid.ColumnDefinitions>
                                                                        <ColumnDefinition Width="50" />
                                                                        <ColumnDefinition Width="300" />
                                                                        <ColumnDefinition Width="150" />
                                                                        <ColumnDefinition Width="300" />
                                                                        <ColumnDefinition Width="150" />
                                                                        <ColumnDefinition Width="150" />
                                                                        <ColumnDefinition Width="150" />
                                                                        <ColumnDefinition Width="200" />
                                                                    </Grid.ColumnDefinitions>

                                                                    <TextBlock
                                                                        Grid.Column="0"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Text="{Binding Stt}" />
                                                                    <TextBlock
                                                                        Grid.Column="1"
                                                                        VerticalAlignment="Center"
                                                                        Text="{Binding Dien_Bien_Ls}"
                                                                        TextTrimming="CharacterEllipsis" />
                                                                    <TextBlock
                                                                        Grid.Column="2"
                                                                        VerticalAlignment="Center"
                                                                        Text="{Binding Giai_DoAn_Benh}"
                                                                        TextTrimming="CharacterEllipsis" />
                                                                    <TextBlock
                                                                        Grid.Column="3"
                                                                        VerticalAlignment="Center"
                                                                        Text="{Binding Hoi_Chan}"
                                                                        TextTrimming="CharacterEllipsis" />
                                                                    <TextBlock
                                                                        Grid.Column="4"
                                                                        VerticalAlignment="Center"
                                                                        Text="{Binding Phau_Thuat}"
                                                                        TextTrimming="CharacterEllipsis" />
                                                                    <TextBlock
                                                                        Grid.Column="5"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Text="{Binding Thoi_Diem_Dbls}" />
                                                                    <TextBlock
                                                                        Grid.Column="6"
                                                                        VerticalAlignment="Center"
                                                                        Style="{StaticResource ErrorTextBlockStyle}"
                                                                        Text="{Binding Nguoi_Thuc_Hien}"
                                                                        TextTrimming="CharacterEllipsis" />
                                                                    <TextBlock
                                                                        Grid.Column="7"
                                                                        VerticalAlignment="Center"
                                                                        Text="{Binding Du_Phong}"
                                                                        TextTrimming="CharacterEllipsis" />
                                                                </Grid>
                                                            </Border>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                            </ScrollViewer>
                                        </materialDesign:Card>
                                    </Grid>
                                </ScrollViewer>
                            </TabItem>
                        </TabControl>


                        <!--  Nút đóng  -->
                        <Button
                            Grid.Row="1"
                            Width="100"
                            Height="36"
                            HorizontalAlignment="Right"
                            Command="{Binding CloseOverlayCommand}"
                            Content="Đóng" />
                    </Grid>
                </materialDesign:Card>
            </Grid>
        </Border>

        <!-- BATCH PROCESSING LOADING OVERLAY -->
        <Border
           
            Background="#80000000"
            Visibility="{Binding IsBatchProcessing, Converter={StaticResource BoolToVis}}">
            <Grid>
                <materialDesign:Card
                    Width="500"
                    Height="300"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Padding="24">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="16" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="16" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="16" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="8" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="24" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>

                        <!-- Title -->
                        <TextBlock
                            Grid.Row="0"
                            FontSize="20"
                            FontWeight="Bold"
                            HorizontalAlignment="Center"
                            Text="Đang xử lý dữ liệu Excel" />

                        <!-- Progress Info -->
                        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center">
                            <TextBlock Text="Đã xử lý: " />
                            <TextBlock
                                FontWeight="Bold"
                                Foreground="{DynamicResource PrimaryHueMidBrush}"
                                Text="{Binding BatchProgress}" />
                            <TextBlock Text=" / " />
                            <TextBlock
                                FontWeight="Bold"
                                Text="{Binding BatchTotal}" />
                            <TextBlock Text=" bệnh nhân" />
                        </StackPanel>

                        <!-- Progress Bar -->
                        <Grid Grid.Row="4">
                            <ProgressBar
                                Height="8"
                                Maximum="{Binding BatchTotal}"
                                Value="{Binding BatchProgress}"
                                Background="{DynamicResource MaterialDesignDivider}"
                                Foreground="{DynamicResource PrimaryHueMidBrush}" />
                            
                            <!-- Progress Percentage -->
                            <TextBlock
                                FontSize="10"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                Foreground="White"
                                Text="{Binding BatchProgressPercentage, StringFormat={}{0:F1}%}" />
                        </Grid>

                        <!-- Status Text -->
                        <TextBlock
                            Grid.Row="6"
                            FontSize="14"
                            HorizontalAlignment="Center"
                            Text="{Binding BatchStatus}"
                            TextWrapping="Wrap"
                            TextAlignment="Center" />

                        <!-- Current Patient -->
                        <TextBlock
                            Grid.Row="8"
                            FontSize="12"
                            HorizontalAlignment="Center"
                            Foreground="{DynamicResource PrimaryHueMidBrush}"
                            Text="{Binding CurrentProcessingPatient, StringFormat='Đang xử lý: {0}'}"
                            TextWrapping="Wrap"
                            TextAlignment="Center"
                            Visibility="{Binding CurrentProcessingPatient, Converter={StaticResource StringToVis}}" />

                        <!-- Statistics -->
                        <Grid Grid.Row="10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <!-- Success Count -->
                            <StackPanel Grid.Column="0" HorizontalAlignment="Center">
                                <TextBlock
                                    FontSize="16"
                                    FontWeight="Bold"
                                    Foreground="Green"
                                    Text="{Binding BatchSuccessCount}" />
                                <TextBlock
                                    FontSize="12"
                                    Text="Thành công" />
                            </StackPanel>

                            <!-- Error Count -->
                            <StackPanel Grid.Column="1" HorizontalAlignment="Center">
                                <TextBlock
                                    FontSize="16"
                                    FontWeight="Bold"
                                    Foreground="Red"
                                    Text="{Binding BatchErrorCount}" />
                                <TextBlock
                                    FontSize="12"
                                    Text="Lỗi" />
                            </StackPanel>

                            <!-- Speed -->
                            <StackPanel Grid.Column="2" HorizontalAlignment="Center">
                                <TextBlock
                                    FontSize="16"
                                    FontWeight="Bold"
                                    Foreground="{DynamicResource PrimaryHueMidBrush}"
                                    Text="{Binding BatchProcessingSpeed, StringFormat={}{0:F1}}" />
                                <TextBlock
                                    FontSize="12"
                                    Text="bệnh nhân/giây" />
                            </StackPanel>
                        </Grid>

                        <!-- Cancel Button -->
                        <Button
                            Grid.Row="11"
                            Width="100"
                            Height="36"
                            Margin="0,16,0,0"
                            HorizontalAlignment="Center"
                            Command="{Binding CancelBatchProcessingCommand}"
                            Content="Hủy"
                            IsEnabled="{Binding CanCancelBatch}" />
                    </Grid>
                </materialDesign:Card>
            </Grid>
        </Border>
    </Grid>
</UserControl>
