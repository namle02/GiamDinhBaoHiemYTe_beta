<UserControl x:Class="WPF_GiamDinhBaoHiem.View.PageView.QLHS_ThongKeLoiPage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             mc:Ignorable="d">

    <UserControl.Resources>
        <!-- Gentle diversified palette -->
        <SolidColorBrush x:Key="PageBg" Color="#FAFBFF"/>
        <SolidColorBrush x:Key="CardBg" Color="#FFFFFFFF"/>
        <SolidColorBrush x:Key="BorderSoft" Color="#E5E7EB"/>
        <SolidColorBrush x:Key="HeaderText" Color="#243447"/>
        <SolidColorBrush x:Key="HeaderBgLeft" Color="#E6F4FF"/>   
        <SolidColorBrush x:Key="HeaderBgRight" Color="#E8FFF3"/>  
        <SolidColorBrush x:Key="AltRowLeft" Color="#F5FAFF"/>
        <SolidColorBrush x:Key="AltRowRight" Color="#F6FFF9"/>

        <!-- Pretty list item style for error list -->
        <Style x:Key="PrettyListItem" TargetType="ListBoxItem">
            <Setter Property="Margin" Value="6,4"/>
            <Setter Property="Padding" Value="10,8"/>
            <Setter Property="Background" Value="#FFFFFFFF"/>
            <Setter Property="BorderBrush" Value="#E5E7EB"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListBoxItem">
                        <Border x:Name="Root"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="10">
                            <ContentPresenter Margin="4"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Root" Property="Background" Value="#F9FAFB"/>
                                <Setter TargetName="Root" Property="BorderBrush" Value="#D1D5DB"/>
                            </Trigger>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Root" Property="Background" Value="#EEF2FF"/>
                                <Setter TargetName="Root" Property="BorderBrush" Value="#C7D2FE"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="GridHeaderLeft" TargetType="DataGridColumnHeader">
            <Setter Property="Background" Value="{StaticResource HeaderBgLeft}"/>
            <Setter Property="Foreground" Value="{StaticResource HeaderText}"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="HorizontalContentAlignment" Value="Center"/>
            <Setter Property="Padding" Value="10,6"/>
        </Style>
        <Style x:Key="GridHeaderRight" TargetType="DataGridColumnHeader">
            <Setter Property="Background" Value="{StaticResource HeaderBgRight}"/>
            <Setter Property="Foreground" Value="{StaticResource HeaderText}"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="HorizontalContentAlignment" Value="Center"/>
            <Setter Property="Padding" Value="10,6"/>
        </Style>

        <Style x:Key="CellText" TargetType="TextBlock">
            <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
            <Setter Property="ToolTip" Value="{Binding Text, RelativeSource={RelativeSource Self}}"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
    </UserControl.Resources>

    <Grid Background="{DynamicResource MaterialDesignPaper}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Card 1: Thống kê lỗi -->
        <materialDesign:Card Grid.Row="0" Margin="16,16,16,8" Padding="16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <StackPanel Grid.Column="0">
                    <TextBlock
                        Foreground="{DynamicResource PrimaryHueMidBrush}"
                        Style="{DynamicResource MaterialDesignHeadline6TextBlock}"
                        Text="THỐNG KÊ LỖI" />
                    <TextBlock
                        Foreground="{DynamicResource MaterialDesignBodyLight}"
                        Style="{DynamicResource MaterialDesignBody2TextBlock}"
                        Text="{}" />
                </StackPanel>
            </Grid>
        </materialDesign:Card>

        <!-- Card 2: Tìm kiếm nội dung lỗi -->
        <materialDesign:Card x:Name="SearchCard" Grid.Row="1" Margin="16,8,16,8" Padding="16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Expander header giống layout BacSiPage -->
                <Expander x:Name="ErrorExpander" Grid.ColumnSpan="3" Background="White" ExpandDirection="Down"
                          Style="{StaticResource MaterialDesignExpander}">
                    <Expander.Header>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <materialDesign:PackIcon Grid.Column="0" Kind="Magnify" VerticalAlignment="Center" Margin="0,0,8,0"/>
                            <TextBox Grid.Column="1" Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                     materialDesign:HintAssist.Hint="Tìm nội dung lỗi..."
                                     Text="{Binding ErrorSearchText, UpdateSourceTrigger=PropertyChanged}"/>
                            <Border Grid.Column="2" Width="0"/>
                        </Grid>
                    </Expander.Header>
                </Expander>

                <!-- Popup overlay: hiển thị danh sách lỗi chồng lên -->
                <Popup IsOpen="{Binding IsExpanded, ElementName=ErrorExpander}"
                       PlacementTarget="{Binding ElementName=SearchCard}"
                       Placement="Bottom"
                       StaysOpen="True"
                       AllowsTransparency="True">
                    <Border Background="White"
                            BorderBrush="#E5E7EB"
                            BorderThickness="1"
                            CornerRadius="10"
                            Padding="8"
                            MaxWidth="{Binding ActualWidth, ElementName=SearchCard}">
                        <ScrollViewer VerticalScrollBarVisibility="Auto"
                                      HorizontalScrollBarVisibility="Disabled"
                                      MaxHeight="320">
                            <ItemsControl ItemsSource="{Binding ErrorListView}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Margin="0,4" Padding="10"
                                                Background="#FFFFFF" BorderBrush="#E5E7EB"
                                                BorderThickness="1" CornerRadius="10">
                                            <DockPanel>
                                                <CheckBox IsChecked="{Binding IsSelected, Mode=TwoWay}"
                                                          VerticalAlignment="Center" Margin="0,0,8,0"/>
                                                <TextBlock Text="{Binding NoiDung}" TextWrapping="Wrap"/>
                                            </DockPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </Border>
                </Popup>
            </Grid>
        </materialDesign:Card>


        <!-- Patients grid card -->
        <materialDesign:Card Grid.Row="2" Margin="16,8,16,8" Padding="16">
            <DockPanel>
                <TextBlock DockPanel.Dock="Top" Text="Danh sách bệnh nhân" FontWeight="SemiBold"/>
                <DataGrid ItemsSource="{Binding Xml1List}"
                          AutoGenerateColumns="False"
                          IsReadOnly="True"
                          CanUserAddRows="False"
                          EnableRowVirtualization="True"
                          EnableColumnVirtualization="True"
                          VirtualizingPanel.IsVirtualizing="True"
                          VirtualizingPanel.VirtualizationMode="Recycling"
                          ScrollViewer.CanContentScroll="True"
                          ColumnHeaderStyle="{StaticResource GridHeaderLeft}"
                          AlternationCount="2"
                          AlternatingRowBackground="{StaticResource AltRowLeft}"
                          Background="{StaticResource CardBg}"
                          BorderBrush="{StaticResource BorderSoft}"
                          HeadersVisibility="Column"
                          RowHeaderWidth="0"
                          Margin="0">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Mã LK"         Binding="{Binding MA_LK}"            Width="120"/>
                        <DataGridTextColumn Header="Họ tên"        Binding="{Binding HO_TEN}"           Width="200"/>
                        <DataGridTextColumn Header="Giới tính"     Binding="{Binding GIOI_TINH}"        Width="90"/>
                        <DataGridTextColumn Header="Vào viện"      Binding="{Binding NGAY_VAO}"         Width="150"/>
                        <DataGridTextColumn Header="Ra viện"       Binding="{Binding NGAY_RA}"          Width="150"/>
                    </DataGrid.Columns>
                </DataGrid>
            </DockPanel>
        </materialDesign:Card>
    </Grid>
</UserControl>
