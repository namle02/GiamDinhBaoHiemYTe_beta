/**
 * Rule 49: Thời gian thực hiện CĐHA chưa đủ theo QTKT
 * Kiểm tra thời gian từ khi thực hiện y lệnh đến khi có kết quả phải đủ thời gian tối thiểu theo quy trình kỹ thuật
 * @param {Object} patientData - Toàn bộ dữ liệu bệnh nhân
 * @returns {Object} - Kết quả validation
 */

const validateRule_Id_49 = async (patientData) => {
    const result = {
        ruleName: 'Thời gian thực hiện CĐHA chưa đủ theo QTKT',
        ruleId: 'Rule_Id_49',
        isValid: true,
        validateField: 'Ma_Dich_Vu',
        validateFile: 'XML3',
        message: '',
        errors: [],
        warnings: []
    };

    try {
        const dsDichVu = Array.isArray(patientData.Xml3) ? patientData.Xml3 : [];

        if (dsDichVu.length === 0) {
            return result;
        }

        // ============================================
        // DANH SÁCH CÁC DỊCH VỤ CẦN CHECK VÀ THỜI GIAN TỐI THIỂU (PHÚT)
        // Format: { 'Ma_Dich_Vu': thoiGianToiThieu (phút) }
        // ============================================
        const danhSachDichVuCanCheck = {
            '18.0244.0046': 12,
            '18.0244.0041': 12,
            '18.0244.0040': 12,
            '18.0220.0041': 12,
            '18.0220.0040': 12,
            '18.0232.0042': 12,
            '18.0232.0041': 12,
            '18.0232.0040': 12,
            '18.0232.0043': 12,
            '18.0283.0046': 20,
            '18.0283.0041': 20,
            '18.0256.0041': 20,
            '18.0269.0042': 20,
            '18.0269.0041': 20,
            '18.0282.0047': 12,
            '18.0282.0040': 12,
            '18.0255.0040': 12,
            '18.0268.0043': 12,
            '18.0268.0040': 12,
            '18.0285.0046': 20,
            '18.0285.0041': 20,
            '18.0258.0041': 20,
            '18.0271.0042': 20,
            '18.0271.0041': 20,
            '18.0284.0047': 12,
            '18.0284.0040': 12,
            '18.0257.0040': 12,
            '18.0270.0043': 12,
            '18.0270.0040': 12,
            '18.0287.0046': 20,
            '18.0260.0041': 20,
            '18.0273.0042': 20,
            '18.0273.0041': 20,
            '18.0286.0047': 12,
            '18.0259.0040': 12,
            '18.0272.0043': 12,
            '18.0272.0040': 12,
            '18.0253.0046': 12,
            '18.0229.0041': 12,
            '18.0241.0041': 12,
            '18.0241.0042': 12,
            '18.0215.0046': 20,
            '18.0215.0042': 20,
            '18.0197.0041': 20,
            '18.0206.0042': 20,
            '18.0254.0046': 20,
            '18.0254.0042': 20,
            '18.0230.0041': 20,
            '18.0242.0042': 20,
            '18.0214.0046': 20,
            '18.0196.0041': 20,
            '18.0205.0042': 20,
            '18.0198.0041': 20,
            '18.0207.0042': 20,
            '18.0216.0046': 20,
            '18.0217.0046': 20,
            '18.0217.0042': 20,
            '18.0249.0046': 12,
            '18.0225.0041': 20,
            '18.0237.0042': 12,
            '18.0163.0040': 20,
            '18.0162.0040': 20,
            '18.0164.0040': 20,
            '18.0248.0046': 20,
            '18.0224.0041': 20,
            '18.0236.0042': 20,
            '18.0246.0046': 12,
            '18.0222.0041': 12,
            '18.0222.0040': 12,
            '18.0234.0042': 12,
            '18.0234.0041': 12,
            '18.0234.0040': 12,
            '18.0234.0043': 12,
            '18.0290.0046': 20,
            '18.0263.0041': 20,
            '18.0276.0042': 20,
            '18.0289.0046': 20,
            '18.0262.0041': 20,
            '18.0275.0042': 20,
            '18.0275.0041': 20,
            '18.0288.0047': 12,
            '18.0261.0040': 12,
            '18.0274.0043': 12,
            '18.0274.0040': 12,
            '18.0210.0046': 20,
            '18.0210.0041': 20,
            '18.0192.0041': 20,
            '18.0201.0042': 20,
            '18.0201.0041': 20,
            '18.0209.0047': 12,
            '18.0209.0040': 12,
            '18.0191.0040': 12,
            '18.0200.0043': 12,
            '18.0200.0040': 12,
            '18.0295.0046': 20,
            '18.0267.0041': 20,
            '18.0281.0042': 20,
            '18.0294.0046': 20,
            '18.0266.0041': 20,
            '18.0280.0042': 20,
            '18.0213.0047': 20,
            '18.0195.0040': 20,
            '18.0204.0043': 20,
            '18.0211.0047': 20,
            '18.0193.0040': 20,
            '18.0202.0043': 20,
            '18.0202.0040': 20,
            '18.0212.0047': 12,
            '18.0252.0046': 20,
            '18.0228.0041': 20,
            '18.0240.0042': 20,
            '18.0251.0047': 12,
            '18.0227.0040': 12,
            '18.0239.0041': 12,
            '18.0239.0043': 12,
            '18.0293.0049': 20,
            '18.0293.0048': 20,
            '18.0279.0045': 20,
            '18.0279.0044': 20,
            '18.0250.0046': 20,
            '18.0226.0041': 20,
            '18.0238.0042': 20,
            '18.0247.0046': 20,
            '18.0223.0041': 20,
            '18.0235.0042': 20,
            '18.0243.0046': 20,
            '18.0243.0041': 20,
            '18.0219.0041': 20,
            '18.0219.0040': 12,
            '18.0231.0042': 20,
            '18.0231.0041': 20,
            '18.0231.0043': 12,
            '18.0231.0040': 20,
            '18.0245.0040': 12,
            '18.0221.0041': 20,
            '18.0221.0040': 12,
            '18.0233.0042': 12,
            '18.0233.0041': 12,
            '18.0233.0040': 12,
            '18.0233.0043': 12,
            '18.0218.0047': 12,
            '18.0199.0040': 12,
            '18.0208.0043': 20,
            '18.0292.0046': 20,
            '18.0265.0041': 20,
            '18.0278.0042': 20,
            '18.0278.0041': 20,
            '18.0291.0047': 12,
            '18.0264.0040': 12,
            '18.0277.0043': 12,
            '18.0277.0040': 12,
            '18.0190.0047': 20,
            '18.0190.0040': 20,
            '18.0161.0040': 20,
            '18.0177.0043': 20,
            '18.0177.0040': 20,
            '18.0186.0047': 20,
            '18.0157.0040': 20,
            '18.0173.0043': 20,
            '18.0185.0046': 20,
            '18.0185.0041': 20,
            '18.0156.0041': 20,
            '18.0172.0042': 20,
            '18.0172.0041': 20,
            '18.0184.0047': 12,
            '18.0184.0040': 12,
            '18.0155.0040': 12,
            '18.0171.0043': 12,
            '18.0171.0040': 12,
            '18.0180.0046': 20,
            '18.0180.0042': 20,
            '18.0151.0041': 20,
            '18.0167.0042': 20,
            '18.0189.0047': 20,
            '18.0160.0041': 12,
            '18.0160.0040': 12,
            '18.0176.0042': 12,
            '18.0176.0041': 12,
            '18.0176.0040': 12,
            '18.0176.0043': 12,
            '18.0182.0046': 20,
            '18.0153.0041': 20,
            '18.0169.0042': 20,
            '18.0183.0047': 12,
            '18.0154.0041': 20,
            '18.0170.0042': 20,
            '18.0170.0041': 20,
            '18.0179.0046': 20,
            '18.0179.0041': 20,
            '18.0150.0041': 20,
            '18.0166.0042': 20,
            '18.0166.0041': 20,
            '18.0178.0047': 12,
            '18.0178.0040': 12,
            '18.0149.0040': 12,
            '18.0165.0043': 12,
            '18.0165.0040': 12,
            '18.0188.0046': 20,
            '18.0159.0041': 20,
            '18.0175.0042': 20,
            '18.0175.0041': 20,
            '18.0187.0047': 12,
            '18.0158.0040': 12,
            '18.0174.0043': 12,
            '18.0174.0040': 12,
            '18.0181.0046': 20,
            '18.0152.0041': 20,
            '18.0168.0042': 20,
            '18.0328.0065': 30,
            '18.0361.0065': 30,
            '18.0360.0065': 30,
            '18.0695.0065': 30,
            '18.0324.0066': 20,
            '18.0325.0065': 30,
            '18.0307.0068': 20,
            '18.0334.0066': 20,
            '18.0335.0065': 30,
            '18.0336.0066': 20,
            '18.0337.0065': 30,
            '18.0338.0066': 20,
            '18.0339.0065': 30,
            '18.0331.0065': 20,
            '18.0309.0065': 20,
            '18.0364.0066': 20,
            '18.0326.0066': 30,
            '18.0354.0066': 20,
            '18.0355.0065': 30,
            '18.0352.0066': 20,
            '18.0353.0065': 30,
            '18.0347.0065': 20,
            '18.0348.0065': 20,
            '18.0349.0065': 20,
            '18.0333.0067': 45,
            '18.0301.0065': 30,
            '18.0300.0066': 20,
            '18.0303.0066': 20,
            '18.0304.0065': 30,
            '18.0340.0066': 20,
            '18.0342.0065': 30,
            '18.0341.0065': 30,
            '18.0308.0066': 20,
            '18.0313.0066': 20,
            '18.0314.0065': 30,
            '18.0299.0065': 30,
            '18.0298.0066': 20,
            '18.0345.0066': 20,
            '18.0346.0065': 30,
            '18.0306.0068': 45,
            '18.0330.0068': 45,
            '18.0318.0068': 30,
            '18.0327.0065': 20,
            '18.0296.0066': 20,
            '18.0312.0068': 45,
            '18.0297.0065': 30,
            '18.0320.0065': 30,
            '18.0319.0066': 20,
            '18.0351.0065': 30,
            '18.0332.0066': 30,
            '18.0315.0065': 30,
            '18.0350.0065': 30,
            '18.0358.0066': 20,
            '18.0359.0065': 30,
            '18.0365.0068': 30,
            '18.0305.0065': 45,
            '18.0329.0065': 30,
            '18.0316.0066': 20,
            '18.0317.0065': 30,
            '18.0302.0065': 30,
            '18.0321.0066': 20,
            '18.0323.0065': 30,
            '18.0322.0065': 20,
            '18.0310.0066': 20,
            '18.0311.0065': 30,
            '18.0343.0066': 20,
            '18.0344.0065': 30,
            '18.0048.0004': 15,
            '18.0053.0007': 15,
            '18.0066.0003': 15,
            '18.0013.0001': 6,
            '18.0002.0001': 6,
            '01.0303.0001': 30,
            '18.0046.0004': 15,
            '18.0003.0001': 6,
            '18.0065.0069': 15,
            '18.0056.0069': 15,
            '18.0005.0069': 15,
            '18.0021.0069': 15,
            '18.0024.0004': 15,
            '18.0037.0004': 15,
            '18.0045.0004': 15,
            '18.0060.0069': 15,
            '18.0022.0069': 15,
            '18.0009.0069': 0,
            '01.0019.0004': 30,
            '02.0112.0004': 15,
            '03.0043.0004': 15,
            '02.0316.0004': 15,
            '02.0315.0004': 15,
            '18.0023.0004': 15,
            '18.0026.0069': 15,
            '18.0058.0069': 15,
            '18.0029.0004': 15,
            '18.0025.0069': 15,
            '18.0033.0004': 15,
            '18.0032.0069': 15,
            '18.0055.0069': 15,
            '18.0010.0069': 15,
            '18.0059.0001': 6,
            '18.0004.0001': 6,
            '18.0016.0001': 6,
            '18.0006.0001': 0,
            '18.0043.0001': 6,
            '02.0373.0001': 6,
            '03.0069.0001': 30,
            '18.0011.0001': 6,
            '01.0092.0001': 30,
            '14.0240.0845': 0,
            '18.0008.0001': 0,
            '18.0015.0001': 6,
            '01.0239.0001': 30,
            '18.0019.0001': 6,
            '18.0044.0001': 6,
            '02.0374.0001': 6,
            '18.0007.0001': 15,
            '18.0020.0001': 15,
            '18.0036.0001': 15,
            '18.0034.0001': 15,
            '18.0035.0001': 15,
            '18.0012.0001': 6,
            '18.0017.0003': 6,
            '18.0057.0001': 6,
            '18.0031.0003': 6,
            '18.0030.0001': 6,
            '18.0001.0001': 6,
            '18.0054.0001': 15,
            '02.0113.0004': 30,
            '18.0052.0004': 30,
            '02.0115.0005': 15,
            '01.0018.0004': 30,
            '03.4249.0004': 30,
            '02.0117.0008': 30,
            '03.0015.0008': 30,
            '03.2820.0004': 30,
            '18.0051.0005': 15,
            '18.0049.0004': 15,
            '18.0050.0008': 30,
            '02.0178.0022': 20,
            '18.0144.0022': 30,
            '18.0141.0020': 30,
            '18.0072.0028': 6,
            '18.0072.0029': 6,
            '18.0125.0028': 6,
            '18.0125.0029': 6,
            '18.0077.0028': 6,
            '18.0089.0010': 6,
            '18.0087.0029': 6,
            '18.0088.0030': 6,
            '18.0086.0029': 6,
            '18.0096.0029': 6,
            '18.0090.0029': 6,
            '18.0092.0029': 6,
            '18.0095.0028': 6,
            '18.0094.0029': 6,
            '18.0093.0029': 6,
            '18.0091.0029': 6,
            '18.0132.0036': 20,
            '18.0123.0012': 6,
            '18.0135.0025': 15,
            '18.0133.0019': 30,
            '18.0074.0028': 6,
            '18.0073.0028': 6,
            '18.0071.0029': 6,
            '18.0097.0030': 6,
            '18.0112.0029': 6,
            '18.0110.0028': 6,
            '18.0109.0028': 6,
            '18.0105.0028': 6,
            '18.0104.0029': 6,
            '18.0122.0013': 6,
            '18.0101.0028': 6,
            '18.0100.0028': 6,
            '18.0100.0029': 6,
            '18.0098.0028': 6,
            '18.0068.0029': 6,
            '18.0069.0028': 6,
            '18.0134.0019': 20,
            '18.0085.0028': 6,
            '18.0120.0028': 6,
            '18.0119.0028': 6,
            '18.0119.0029': 6,
            '18.0143.0033': 20,
            '18.0140.0032': 20,
            '18.0142.0033': 30,
            '18.0139.0039': 15,
            '18.0129.0029': 6,
            '18.0083.0028': 6,
            '18.0131.0035': 20,
            '18.0078.0028': 6,
            '18.0067.0029': 6,
            '18.0070.0028': 6,
            '18.0079.0028': 6,
            '18.0127.0028': 6,
            '18.0128.0028': 30,
            '18.0124.0034': 6,
            '18.0130.0035': 15,
            '18.0118.0030': 15,
            '18.0138.0031': 20,
            '18.0136.0039': 20,
            '18.0126.0026': 15,
            '18.0102.0029': 6,
            '18.0108.0029': 6,
            '18.0116.0029': 6,
            '18.0113.0029': 6,
            '18.0114.0029': 6,
            '18.0106.0029': 6,
            '18.0103.0029': 6,
            '18.0075.0028': 6,
            '18.0115.0029': 6,
            '18.0107.0029': 6,
            '18.0099.0028': 6,
            '18.0111.0029': 6,
            '18.0117.0029': 6,
            '18.0121.0029': 6,
            '03.0007.0391': 6
        };

        // Hàm chuyển đổi chuỗi ngày giờ thành Date object
        const parseDateTime = (dateTimeStr, fieldName = '') => {
            if (!dateTimeStr) {
                return null;
            }
            
            let str = dateTimeStr.toString().trim();
            
            // Nếu có định dạng yyyyMMddHHmmss
            if (str.length === 14 && /^\d+$/.test(str)) {
                const year = parseInt(str.substring(0, 4));
                const month = parseInt(str.substring(4, 6)) - 1; // Month is 0-indexed
                const day = parseInt(str.substring(6, 8));
                const hour = parseInt(str.substring(8, 10));
                const minute = parseInt(str.substring(10, 12));
                const second = parseInt(str.substring(12, 14));
                const parsedDate = new Date(year, month, day, hour, minute, second);
                if (Number.isNaN(parsedDate.getTime())) {
                    return null;
                }
                return parsedDate;
            }

            // Nếu có định dạng yyyyMMddHHmm (ví dụ: 202412241400 = 24/12/2024 14:00)
            if (str.length === 12 && /^\d+$/.test(str)) {
                const year = parseInt(str.substring(0, 4));
                const month = parseInt(str.substring(4, 6)) - 1; // Month is 0-indexed
                const day = parseInt(str.substring(6, 8));
                const hour = parseInt(str.substring(8, 10));
                const minute = parseInt(str.substring(10, 12));
                const parsedDate = new Date(year, month, day, hour, minute, 0);
                if (Number.isNaN(parsedDate.getTime())) {
                    return null;
                }
                return parsedDate;
            }
            
            // Nếu có định dạng yyyyMMdd
            if (str.length === 8 && /^\d+$/.test(str)) {
                const year = parseInt(str.substring(0, 4));
                const month = parseInt(str.substring(4, 6)) - 1;
                const day = parseInt(str.substring(6, 8));
                const parsedDate = new Date(year, month, day);
                if (Number.isNaN(parsedDate.getTime())) {
                    return null;
                }
                return parsedDate;
            }
            
            // Nếu có định dạng yyyy-MM-dd HH:mm:ss hoặc yyyy-MM-dd
            if (str.includes('-')) {
                const parsedDate = new Date(str);
                if (Number.isNaN(parsedDate.getTime())) {
                    return null;
                }
                return parsedDate;
            }
            
            return null;
        };

        // Hàm tính số phút giữa hai ngày
        const tinhSoPhut = (ngayBatDau, ngayKetThuc, maDichVu = '') => {
            if (!ngayBatDau || !ngayKetThuc) {
                return null;
            }
            
            const date1 = parseDateTime(ngayBatDau, 'Ngay_th_YL');
            const date2 = parseDateTime(ngayKetThuc, 'Ngay_kq');
            
            if (!date1 || !date2) {
                return null;
            }
            
            // Tính hiệu số miliseconds và chuyển sang phút
            const diffMs = date2.getTime() - date1.getTime();
            const diffMinutes = Math.floor(diffMs / (1000 * 60));
            
            return diffMinutes;
        };

        // Helper: lấy field đầu tiên có giá trị (tránh lệch tên key do hoa/thường)
        const pickFirstValue = (obj, keys) => {
            for (const k of keys) {
                const v = obj?.[k];
                if (v !== undefined && v !== null && v !== '') return v;
            }
            return null;
        };

        // Kiểm tra từng dịch vụ trong XML3
        let soDichVuCanCheck = 0;
        dsDichVu.forEach((dv) => {
            const maDichVu = dv.Ma_Dich_Vu;
            
            // Kiểm tra xem Ma_Dich_Vu có trong danh sách cần check không
            if (!maDichVu || !danhSachDichVuCanCheck.hasOwnProperty(maDichVu)) {
                return; // Bỏ qua nếu không thuộc danh sách cần check
            }

            soDichVuCanCheck++;
            // Lấy thời gian tối thiểu cho dịch vụ này
            const thoiGianToiThieu = danhSachDichVuCanCheck[maDichVu];
            
            // Lấy Ngay_kq và Ngay_th_YL
            const ngayKq = pickFirstValue(dv, ['Ngay_kq', 'Ngay_Kq', 'Ngay_KQ', 'Ngay_kQ']);
            const ngayThYL = pickFirstValue(dv, [
                // các biến thể thực tế hay gặp trong data
                'Ngay_th_YL', 'Ngay_Th_YL', 'Ngay_th_Yl', 'Ngay_Th_Yl',
                'Ngay_th_yl', 'Ngay_Th_yl',
                // theo sample mongo bạn gửi
                'Ngay_Th_Yl',
                // fallback: một số nơi có thể dùng Ngay_Yl làm thời điểm y lệnh
                'Ngay_Yl', 'Ngay_YL'
            ]);
            
            // Kiểm tra nếu thiếu dữ liệu ngày
            if (!ngayKq || !ngayThYL) {
                result.warnings.push({
                    Id: dv.id || dv.Id,
                    Error: `Dịch vụ ${maDichVu} thiếu thông tin ngày (Ngay_kq hoặc Ngay_th_YL)`
                });
                return;
            }

            // Tính số phút giữa Ngay_kq và Ngay_th_YL
            const soPhut = tinhSoPhut(ngayThYL, ngayKq, maDichVu);
            
            if (soPhut === null) {
                result.warnings.push({
                    Id: dv.id || dv.Id,
                    Error: `Dịch vụ ${maDichVu} không thể tính được thời gian (định dạng ngày không hợp lệ)`
                });
                return;
            }

            // So sánh với thời gian tối thiểu
            // Nếu nhỏ hơn thời gian tối thiểu thì sai
            if (soPhut < thoiGianToiThieu) {
                result.isValid = false;
                result.errors.push({
                    Id: dv.id || dv.Id,
                    Error: `Dịch vụ ${maDichVu} có thời gian thực hiện ${soPhut} phút, chưa đủ thời gian tối thiểu ${thoiGianToiThieu} phút theo QTKT`
                });
            }
        });

        if (result.errors.length > 0) {
            result.message = 'Có dịch vụ CĐHA có thời gian thực hiện chưa đủ theo QTKT';
        }

    } catch (error) {
        result.isValid = false;
        result.errors.push(`Lỗi khi validate Thời gian thực hiện CĐHA chưa đủ theo QTKT: ${error.message}`);
        result.message = 'Lỗi khi validate Thời gian thực hiện CĐHA chưa đủ theo QTKT';
    }

    return result;
};

module.exports = validateRule_Id_49;
